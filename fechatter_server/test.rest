### Variables
@baseUrl = http://localhost:6688

### signup
# @name signup
POST {{baseUrl}}/api/signup
Content-Type: application/json

{
  "fullname": "Alice", 
  "email": "alice@acmn.com",
  "password": "password",
  "workspace": "Acme"
}

### Save response tokens
@accessToken = {{signup.response.body.$.access_token}}
@refreshToken = {{signup.response.body.$.refresh_token}}


### signup (second user)
# @name signup2
POST {{baseUrl}}/api/signup
Content-Type: application/json

{
  "fullname": "Bob",
  "email": "bob@acmn.com", 
  "password": "rhunter48",
  "workspace": "Acme"
}

### signup (third user)
# @name signup3
POST {{baseUrl}}/api/signup
Content-Type: application/json

{
  "fullname": "Charlie",
  "email": "charlie@acmn.com",
  "password": "paf334200",
  "workspace": "Acme"
}

### signin
# @name login
POST {{baseUrl}}/api/signin
Content-Type: application/json

{
  "email": "alice@acmn.com",
  "password": "password"
}

### Save response tokens from login
@loginAccessToken = {{login.response.body.$.access_token}}
@loginRefreshToken = {{login.response.body.$.refresh_token}}

### Refresh token using cookies
# @name refreshWithCookie
POST {{baseUrl}}/api/refresh
Content-Type: application/json
Cookie: refresh_token={{loginRefreshToken}}

### Save new tokens from refresh with cookie
@accessTokenFromCookie = {{refreshWithCookie.response.body.$.access_token}}
@refreshTokenFromCookie = {{refreshWithCookie.response.body.$.refresh_token}}

### signin (second login to get fresh tokens)
# @name login2
POST {{baseUrl}}/api/signin
Content-Type: application/json

{
  "email": "alice@acmn.com",
  "password": "password"
}

### Save tokens from second login
@accessToken = {{login2.response.body.$.access_token}}
@refreshToken = {{login2.response.body.$.refresh_token}}

### Refresh token using Authorization header
# @name refreshWithHeader
POST {{baseUrl}}/api/refresh
Content-Type: application/json
Authorization: Bearer {{refreshToken}}

### Save new tokens from refresh
@newAccessToken = {{refreshWithHeader.response.body.$.access_token}}
@newRefreshToken = {{refreshWithHeader.response.body.$.refresh_token}}

### list users
GET {{baseUrl}}/api/users
Authorization: Bearer {{newAccessToken}}

### signin (invalid user)
POST {{baseUrl}}/api/signin
Content-Type: application/json

{
  "email": "nonexist@acmn.com",
  "password": "password"
}

### signin (invalid password)
POST {{baseUrl}}/api/signin
Content-Type: application/json

{
  "email": "alice@acmn.com",
  "password": "invalid"
}

### list chats
GET {{baseUrl}}/api/chat
Authorization: Bearer {{loginAccessToken}}

### create chat
# @name createChat
POST {{baseUrl}}/api/chat
Content-Type: application/json
Authorization: Bearer {{accessToken}}

{
  "name": "Test1 Chat",
  "chat_type": "Group", 
  "members": [1, 2, 3],
  "description": "This is a test chat"
}

### Get chat ID from response
@chatId = {{createChat.response.body.$.id}}

### update chat
PATCH {{baseUrl}}/api/chat/{{chatId}}
Content-Type: application/json
Authorization: Bearer {{accessToken}}

{
  "name": "Updated Chat3",
  "description": "This is an updated test chat"
}

### upload file (if file does not exist, please modify the path)
# @name uploadFile
POST {{baseUrl}}/api/upload
Authorization: Bearer {{accessToken}}
Content-Type: multipart/form-data; boundary=MyBoundary

--MyBoundary
Content-Disposition: form-data; filename="test.txt"
Content-Type: text/plain

Hello, world!
--MyBoundary
Content-Disposition: form-data; filename="queryPane.png"
Content-Type: image/png

< /Users/zhangkaiqi/Downloads/queryPane.png
--MyBoundary--

### Get uploaded file URL from response
# File URL format: /files/{workspace_id}/{part1}/{part2}/{part3}.{ext}
# Example: /files/1/2a8/8ea/366b6ca7f43e61ae1559b372608fe6c170.png
@fileUrl = {{uploadFile.response.body.$[0]}}

### Extract image hash ID (from URL)
# File URL format is /files/1/2a8/8ea/366b6ca7f43e61ae1559b372608fe6c170.png
# Extract hash ID: 2a88ea366b6ca7f43e61ae1559b372608fe6c170
@fileHash = 2a88ea366b6ca7f43e61ae1559b372608fe6c170

### Access file (using full path)
# Note: API requires /files/{workspace_id}/{part1}/{part2}/{part3}.{ext} format
# Example: /files/1/2a8/8ea/366b6ca7f43e61ae1559b372608fe6c170.png
GET {{baseUrl}}/api/files/1/e89/663/c9ef07886b308ac0ea964f143e30ccc924db69f8cbc483299e566b0ff6.png
Authorization: Bearer {{accessToken}}

### Test file directory
GET {{baseUrl}}/api/files
Authorization: Bearer {{accessToken}}

### Test workspace file directory (ensure trailing slash)
GET {{baseUrl}}/api/files/1/
Authorization: Bearer {{accessToken}}

### Note: Old format URLs are no longer supported
# The following request will fail
# GET {{baseUrl}}/api/files/366b6ca7f43e61ae1559b372608fe6c170.png
# Authorization: Bearer {{accessToken}}


### send message
POST {{baseUrl}}/api/chat/1/messages
Content-Type: application/json
Authorization: Bearer {{accessToken}}

{
  "content": "Hello, this is a content message",
  "files": []
}

### send message with file
POST {{baseUrl}}/api/chat/1/messages
Content-Type: application/json
Authorization: Bearer {{accessToken}}

{
  "content": "Hello, this is a test message with file",
  "files": ["{{fileUrl}}"]
}

### list messages
GET {{baseUrl}}/api/chat/{{chatId}}/messages
Authorization: Bearer {{loginAccessToken}}

### Logout with cookies
POST {{baseUrl}}/api/logout
Authorization: Bearer {{accessToken}}

### Logout with refresh token in Authorization header
POST {{baseUrl}}/api/logout
Authorization: Bearer {{refreshToken}}

### Attempt to use revoked refresh token (should fail)
POST {{baseUrl}}/api/refresh
Content-Type: application/json
Authorization: Bearer {{refreshToken}}

### logout all sessions (need authentication)
POST {{baseUrl}}/api/logout-all
Authorization: Bearer {{accessToken}}
