# ç®€åŒ–ä¸­é—´ä»¶æ¶æ„æŒ‡å—

ç»è¿‡å‰ªæé‡æ„ï¼Œä¸­é—´ä»¶æ¶æ„å·²ç®€åŒ–ä¸º**å®ç”¨ä¸»ä¹‰è®¾è®¡**ï¼Œä¸“æ³¨äºæ ¸å¿ƒåŠŸèƒ½å’Œæ˜“ç”¨æ€§ã€‚

## ğŸ¯ è®¾è®¡ç›®æ ‡

- **ç®€æ´ä½†å®Œæ•´**ï¼šä¿ç•™æ‰€æœ‰å¿…è¦åŠŸèƒ½ï¼Œå»é™¤è¿‡åº¦è®¾è®¡
- **é›¶æˆæœ¬æŠ½è±¡ç²¾é«“**ï¼šå†…è”ä¼˜åŒ–ï¼Œç¼–è¯‘æ—¶ä¼˜åŒ–
- **å‘åå…¼å®¹**ï¼šç°æœ‰ä»£ç å¯æ— ç¼è¿ç§»
- **æ˜“äºç»´æŠ¤**ï¼šå•æ–‡ä»¶å®ç°ï¼Œé€»è¾‘æ¸…æ™°

## ğŸ“ æ–‡ä»¶ç»“æ„

```
src/middlewares/
â”œâ”€â”€ optimized.rs        # ğŸŒŸ ä¸»è¦å®ç° - æ¨èä½¿ç”¨
â”œâ”€â”€ mod.rs             # å¯¼å‡ºå’Œé¢„è®¾
â”œâ”€â”€ authorization.rs   # ä¼ ç»Ÿæˆæƒä¸­é—´ä»¶
â”œâ”€â”€ builder.rs         # ä¼ ç»Ÿæ„å»ºå™¨ 
â”œâ”€â”€ chat.rs           # èŠå¤©æƒé™éªŒè¯
â””â”€â”€ workspace.rs      # å·¥ä½œç©ºé—´ä¸Šä¸‹æ–‡
```

## ğŸš€ æ¨èç”¨æ³•

### åŸºç¡€è®¤è¯
```rust
use fechatter_server::middlewares::prelude::*;

let router = Router::new()
    .route("/api/users", get(list_users))
    .with_auth(state);
```

### å·¥ä½œç©ºé—´çº§åˆ«
```rust
let router = Router::new()
    .route("/api/workspace/data", get(get_data))
    .with_workspace(state);
```

### èŠå¤©çº§åˆ«
```rust
let router = Router::new()
    .route("/api/chat/{id}/messages", get(list_messages))
    .with_chat(state);
```

### å®Œæ•´æƒé™é“¾
```rust
let router = Router::new()
    .route("/api/message/{id}", patch(edit_message))
    .with_full_auth(state);
```

## ğŸ”„ å‘åå…¼å®¹ç”¨æ³•

```rust
let router = Router::new()
    .route("/api/data", get(get_data))
    .with_middlewares(state)
    .with_auth_refresh()
    .build();
```

## âš¡ æ€§èƒ½ç‰¹å¾

| ç‰¹å¾ | ä¼˜åŒ–ç‰ˆæœ¬ | ä¼ ç»Ÿç‰ˆæœ¬ |
|------|----------|----------|
| ç¼–è¯‘æ—¶é—´ | å¿« âš¡ | æ ‡å‡† |
| è¿è¡Œæ—¶æ€§èƒ½ | ä¼˜ç§€ ğŸš€ | è‰¯å¥½ |
| å†…å­˜ä½¿ç”¨ | æœ€ä¼˜ ğŸ’¾ | æ ‡å‡† |
| APIå¤æ‚åº¦ | ç®€å• âœ… | ä¸­ç­‰ |

## ğŸ”§ æ ¸å¿ƒç‰¹æ€§

### 1. å†…è”ä¼˜åŒ–
æ‰€æœ‰æ ¸å¿ƒå‡½æ•°éƒ½ä½¿ç”¨ `#[inline]` ä¼˜åŒ–ï¼Œç¡®ä¿é›¶è¿è¡Œæ—¶å¼€é”€ã€‚

### 2. æ™ºèƒ½æƒé™æ¨æ–­
æ ¹æ®HTTPæ–¹æ³•è‡ªåŠ¨æ¨æ–­æƒé™ç±»å‹ï¼š
- `GET` â†’ `Permission::Read`
- `POST/PUT/PATCH/DELETE` â†’ `Permission::Write`

### 3. çµæ´»çš„ä¸Šä¸‹æ–‡ä¼ é€’
é€šè¿‡ `MiddlewareContext` åœ¨ä¸­é—´ä»¶é—´ä¼ é€’çŠ¶æ€ï¼š
```rust
pub struct MiddlewareContext {
    pub user: Option<AuthUser>,
    pub workspace_id: Option<i64>,
    pub chat_id: Option<i64>,
    pub permissions: Vec<Permission>,
}
```

### 4. è‡ªåŠ¨èµ„æºIDæå–
æ™ºèƒ½ä»URLè·¯å¾„æå–èµ„æºIDï¼š
- `/api/workspace/123/data` â†’ `workspace_id: 123`
- `/api/chat/456/messages` â†’ `chat_id: 456`

## ğŸ“Š å‰ªææˆæœ

### åˆ é™¤çš„å¤æ‚æ–‡ä»¶
- âŒ `core/` ç›®å½• (4ä¸ªæ–‡ä»¶)
- âŒ `unified_architecture.rs`
- âŒ `unified_builder.rs`
- âŒ å¤æ‚çš„æ¶æ„æ–‡æ¡£

### ä¿ç•™çš„æ ¸å¿ƒåŠŸèƒ½
- âœ… è®¤è¯å’Œæƒé™éªŒè¯
- âœ… é›¶æˆæœ¬æŠ½è±¡æ€æƒ³
- âœ… å‘åå…¼å®¹æ€§
- âœ… æ€§èƒ½ä¼˜åŒ–

### ä»£ç è¡Œæ•°å¯¹æ¯”
- **ä¹‹å‰**ï¼š~2000è¡Œ (å¤šæ–‡ä»¶åˆ†æ•£)
- **ç°åœ¨**ï¼š~400è¡Œ (å•æ–‡ä»¶é›†ä¸­)
- **å‡å°‘**ï¼š80% ä»£ç é‡

## ğŸ¯ ä½¿ç”¨å»ºè®®

### æ–°é¡¹ç›®
ç›´æ¥ä½¿ç”¨ä¼˜åŒ–ç‰ˆæœ¬ï¼š
```rust
use fechatter_server::middlewares::prelude::*;
```

### ç°æœ‰é¡¹ç›®è¿ç§»
é€æ­¥æ›¿æ¢ï¼Œä¿æŒå…¼å®¹ï¼š
```rust
// è€ä»£ç ç»§ç»­å·¥ä½œ
router.with_middlewares(state).with_auth_refresh().build()

// æ–°ä»£ç ä½¿ç”¨ä¼˜åŒ–ç‰ˆæœ¬
router.with_auth(state)
```

### æ€§èƒ½æ•æ„Ÿåœºæ™¯
ä½¿ç”¨å®Œæ•´æƒé™é“¾ï¼š
```rust
router.with_full_auth(state)  // å†…è”ä¼˜åŒ–ï¼Œæœ€ä½³æ€§èƒ½
```

## ğŸ”® æ¶æ„ä¼˜åŠ¿

1. **ç®€æ´æ€§**ï¼šå•æ–‡ä»¶å®ç°ï¼Œæ˜“äºç†è§£å’Œç»´æŠ¤
2. **å®ç”¨æ€§**ï¼šä¸“æ³¨è§£å†³å®é™…é—®é¢˜ï¼Œä¸è¿‡åº¦è®¾è®¡
3. **æ€§èƒ½**ï¼šä¿ç•™é›¶æˆæœ¬æŠ½è±¡ç²¾é«“ï¼Œè¿è¡Œæ—¶ä¼˜åŒ–
4. **å…¼å®¹æ€§**ï¼šå¹³æ»‘è¿ç§»ï¼Œæ— ç ´åæ€§å˜æ›´
5. **æ‰©å±•æ€§**ï¼šç®€å•çš„è®¾è®¡æ›´å®¹æ˜“æ‰©å±•

---

*è¿™æ˜¯ä¸€ä¸ªå®ç”¨ä¸»ä¹‰çš„ä¸­é—´ä»¶æ¶æ„ï¼Œä¸“æ³¨äºæ ¸å¿ƒåŠŸèƒ½å’Œå¼€å‘ä½“éªŒã€‚* ğŸ¯ 