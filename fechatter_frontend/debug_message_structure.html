<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Message Structure Debug</title>
  <style>
    body {
      font-family: monospace;
      padding: 20px;
    }

    .log {
      margin: 10px 0;
      padding: 10px;
      background: #f5f5f5;
      border-radius: 4px;
    }

    .error {
      background: #ffe6e6;
      color: #d63384;
    }

    .success {
      background: #e6f7e6;
      color: #198754;
    }

    .info {
      background: #e6f3ff;
      color: #0d6efd;
    }

    .warning {
      background: #fff3cd;
      color: #664d03;
    }
  </style>
</head>

<body>
  <h1>üîç Message Structure Debug Tool</h1>
  <button onclick="debugMessageStructure()">Run Debug</button>
  <button onclick="clearLogs()">Clear Logs</button>

  <div id="logs"></div>

  <script type="module">
    let logContainer = document.getElementById('logs');

    function log(message, type = 'info') {
      const div = document.createElement('div');
      div.className = `log ${type}`;
      div.textContent = message;
      logContainer.appendChild(div);
      console.log(message);
    }

    function clearLogs() {
      logContainer.innerHTML = '';
    }

    async function debugMessageStructure() {
      clearLogs();
      log('üîç Starting message structure debugging...', 'info');

      try {
        // Try to access the UnifiedMessageService from the main app
        if (!window.unifiedMessageService) {
          log('‚ùå UnifiedMessageService not found in window', 'error');
          log('‚ÑπÔ∏è Please run this debug tool from the main Fechatter app', 'warning');

          // Try alternative access methods
          if (window.parent && window.parent.unifiedMessageService) {
            window.unifiedMessageService = window.parent.unifiedMessageService;
            log('‚úÖ Found UnifiedMessageService in parent window', 'success');
          } else {
            log('‚ùå Cannot access UnifiedMessageService', 'error');
            return;
          }
        }

        const unifiedMessageService = window.unifiedMessageService;
        const chatId = 3; // From the error log

        const messages = unifiedMessageService.getMessagesForChat(chatId) || [];
        log(`üìä Found ${messages.length} messages for chat ${chatId}`, 'info');

        if (messages.length === 0) {
          log('‚ö†Ô∏è No messages found - checking message cache', 'warning');

          const messageCache = unifiedMessageService.getMessageCache() || {};
          const cacheKeys = Object.keys(messageCache);
          log(`üìã Message cache keys: ${cacheKeys.join(', ')}`, 'info');

          if (cacheKeys.length > 0) {
            const allCachedMessages = Object.values(messageCache).flat();
            log(`üìä Total cached messages: ${allCachedMessages.length}`, 'info');

            // Check if chat 3 exists under different key
            cacheKeys.forEach(key => {
              const cacheMessages = messageCache[key].messages || messageCache[key];
              if (Array.isArray(cacheMessages) && cacheMessages.length > 0) {
                log(`üìÅ Cache "${key}": ${cacheMessages.length} messages`, 'info');

                // Check first message structure
                const firstMsg = cacheMessages[0];
                log(`üìù Sample from "${key}": ${JSON.stringify({
                  id: firstMsg.id,
                  content: firstMsg.content,
                  chat_id: firstMsg.chat_id,
                  contentType: typeof firstMsg.content,
                  allFields: Object.keys(firstMsg)
                }, null, 2)}`, 'info');
              }
            });
          }

          return;
        }

        // Analyze message structure
        log('üîç Analyzing message structure:', 'info');

        const sampleMessages = messages.slice(0, 3);
        sampleMessages.forEach((msg, index) => {
          log(`üìù Message ${index + 1}: ${JSON.stringify({
            id: msg.id,
            content: msg.content,
            contentType: typeof msg.content,
            contentLength: msg.content ? msg.content.length : 0,
            contentPreview: msg.content ? msg.content.substring(0, 50) + '...' : 'EMPTY',
            allFields: Object.keys(msg),
            chat_id: msg.chat_id
          }, null, 2)}`, 'info');
        });

        // Test search logic
        log('üîç Testing search logic:', 'info');
        const query = 'Hi';

        // Filter valid messages
        const validMessages = messages.filter(msg =>
          msg &&
          msg.content &&
          typeof msg.content === 'string' &&
          msg.id &&
          msg.created_at
        );

        log(`‚úÖ Valid messages: ${validMessages.length}/${messages.length}`, validMessages.length > 0 ? 'success' : 'warning');

        // Show invalid messages
        const invalidMessages = messages.filter(msg =>
          !msg ||
          !msg.content ||
          typeof msg.content !== 'string' ||
          !msg.id ||
          !msg.created_at
        );

        if (invalidMessages.length > 0) {
          log(`‚ùå Invalid messages: ${invalidMessages.length}`, 'warning');
          invalidMessages.slice(0, 2).forEach((msg, index) => {
            log(`  Invalid ${index + 1}: ${JSON.stringify({
              hasMsg: !!msg,
              hasContent: msg ? !!msg.content : false,
              contentType: msg ? typeof msg.content : 'no msg',
              hasId: msg ? !!msg.id : false,
              hasCreatedAt: msg ? !!msg.created_at : false
            }, null, 2)}`, 'warning');
          });
        }

        // Test search matching
        const searchResults = validMessages.filter(msg =>
          msg.content.toLowerCase().includes(query.toLowerCase())
        );

        log(`üîç Search results for "${query}": ${searchResults.length}`, searchResults.length > 0 ? 'success' : 'warning');

        if (searchResults.length === 0 && validMessages.length > 0) {
          log('üîç Sample valid message contents:', 'info');
          validMessages.slice(0, 5).forEach((msg, index) => {
            const content = msg.content.toLowerCase();
            const hasHi = content.includes('hi');
            log(`  Valid ${index + 1}: "${msg.content.substring(0, 100)}" - contains "hi": ${hasHi}`, hasHi ? 'success' : 'info');
          });
        } else if (searchResults.length > 0) {
          log('‚úÖ Found matching messages:', 'success');
          searchResults.slice(0, 3).forEach((msg, index) => {
            log(`  Match ${index + 1}: "${msg.content}"`, 'success');
          });
        }

        // Final analysis
        log('üìã Debug Summary:', 'info');
        log(`- Total messages in chat ${chatId}: ${messages.length}`, 'info');
        log(`- Valid messages: ${validMessages.length}`, 'info');
        log(`- Invalid messages: ${invalidMessages.length}`, 'info');
        log(`- Search matches for "${query}": ${searchResults.length}`, 'info');

      } catch (error) {
        log(`‚ùå Debug failed: ${error.message}`, 'error');
        console.error(error);
      }
    }

    // Make functions available globally
    window.debugMessageStructure = debugMessageStructure;
    window.clearLogs = clearLogs;

    log('üîß Debug tool loaded. Click "Run Debug" to start.', 'info');
  </script>
</body>

</html>