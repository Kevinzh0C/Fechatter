<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Image Loading Fix Verification</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f8f9fa;
    }

    .header {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      color: white;
      padding: 30px;
      border-radius: 12px;
      margin-bottom: 30px;
      text-align: center;
    }

    .section {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .log-entry {
      padding: 8px 12px;
      margin: 5px 0;
      border-radius: 6px;
      font-size: 14px;
    }

    .log-success {
      background: #d4edda;
      color: #155724;
      border-left: 4px solid #28a745;
    }

    .log-error {
      background: #f8d7da;
      color: #721c24;
      border-left: 4px solid #dc3545;
    }

    .log-warning {
      background: #fff3cd;
      color: #856404;
      border-left: 4px solid #ffc107;
    }

    .log-info {
      background: #d1ecf1;
      color: #0c5460;
      border-left: 4px solid #17a2b8;
    }

    button {
      background: #28a745;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin: 8px;
    }

    button:hover {
      background: #218838;
    }

    .comparison {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin: 20px 0;
    }

    .before,
    .after {
      padding: 15px;
      border-radius: 8px;
      font-family: 'Monaco', 'Consolas', monospace;
      font-size: 13px;
    }

    .before {
      background: #f8d7da;
      border: 2px solid #dc3545;
    }

    .after {
      background: #d4edda;
      border: 2px solid #28a745;
    }
  </style>
</head>

<body>
  <div class="header">
    <h1>‚úÖ Image Loading Fix Verification</h1>
    <p>Verifying URL format fix from /files/ to /api/files/ based on test.rest</p>
  </div>

  <div class="section">
    <h2>üéØ Fix Verification Results</h2>

    <div class="comparison">
      <div class="before">
        <h4>‚ùå Before Fix</h4>
        <div><strong>Generated URL:</strong></div>
        <div>/files/2/60c/155/filename.png</div>
        <div><strong>Result:</strong> 404 Not Found</div>
        <div><strong>Console Error:</strong> /files/2/ (incomplete)</div>
      </div>
      <div class="after">
        <h4>‚úÖ After Fix</h4>
        <div><strong>Generated URL:</strong></div>
        <div>/api/files/2/60c/155/filename.png</div>
        <div><strong>Result:</strong> Should load correctly</div>
        <div><strong>Format:</strong> Matches test.rest</div>
      </div>
    </div>

    <button onclick="verifyImageLoading()">Verify Current Image Loading</button>
    <button onclick="testUrlGeneration()">Test URL Generation</button>
    <button onclick="checkConsoleForFixes()">Check Console for Fix Evidence</button>

    <div id="verification-results"></div>
  </div>

  <div class="section">
    <h2>üîß Files Modified</h2>
    <div class="log-info">
      <strong>1. fileUrlHandler.js:</strong><br>
      - Changed constructHashUrl() to generate /api/files/ format<br>
      - Added empty filename validation<br>
      - Fixed normalizeUrlString() for consistent /api/files/ output
    </div>
    <div class="log-info">
      <strong>2. EnhancedImageThumbnail.vue:</strong><br>
      - Already using getStandardFileUrl() correctly<br>
      - Added debug logging for URL generation
    </div>
    <div class="log-info">
      <strong>3. DiscordMessageItem.vue:</strong><br>
      - getFileUrl() calls getStandardFileUrl() correctly<br>
      - Security enhancements maintained
    </div>
  </div>

  <script>
    function log(message, type = 'info') {
      const div = document.createElement('div');
      div.className = `log-entry log-${type}`;
      div.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
      document.getElementById('verification-results').appendChild(div);
    }

    function verifyImageLoading() {
      log('üîç Verifying current image loading status...', 'info');

      const images = document.querySelectorAll('img');
      let apiFileImages = 0;
      let legacyFileImages = 0;
      let successfulImages = 0;
      let failedImages = 0;

      images.forEach((img, index) => {
        const src = img.src;

        if (src.includes('/api/files/')) {
          apiFileImages++;
          if (img.naturalWidth > 0) {
            successfulImages++;
            log(`‚úÖ Image ${index + 1}: /api/files/ format loading successfully`, 'success');
          } else {
            failedImages++;
            log(`‚ùå Image ${index + 1}: /api/files/ format but failed to load: ${src}`, 'error');
          }
        } else if (src.includes('/files/')) {
          legacyFileImages++;
          log(`‚ö†Ô∏è Image ${index + 1}: Still using legacy /files/ format: ${src}`, 'warning');
        }
      });

      log(`üìä Summary: ${apiFileImages} /api/files/ images, ${legacyFileImages} legacy /files/ images`, 'info');
      log(`üìä Status: ${successfulImages} successful, ${failedImages} failed`,
        failedImages === 0 ? 'success' : 'warning');

      if (apiFileImages > legacyFileImages) {
        log('üéâ Fix appears to be working! Most images now use /api/files/ format', 'success');
      } else if (legacyFileImages > 0) {
        log('‚ö†Ô∏è Some images still use legacy format. May need page refresh.', 'warning');
      }
    }

    function testUrlGeneration() {
      log('üß™ Testing URL generation with mock fileUrlHandler...', 'info');

      // Simulate the fixed fileUrlHandler logic
      function mockGetStandardFileUrl(fileInput, options = {}) {
        const workspaceId = options.workspaceId || 2;

        if (!fileInput) {
          log('‚ùå Empty fileInput provided', 'error');
          return null;
        }

        if (typeof fileInput === 'string') {
          if (fileInput.startsWith('/api/files/')) return fileInput;
          return mockConstructHashUrl(fileInput, workspaceId);
        }

        if (typeof fileInput === 'object') {
          const url = fileInput.file_url || fileInput.url || fileInput.filename || fileInput.file_name;
          if (!url) {
            log('‚ùå No URL found in file object', 'error');
            return null;
          }
          if (url.startsWith('/api/files/')) return url;
          return mockConstructHashUrl(url, workspaceId);
        }

        return null;
      }

      function mockConstructHashUrl(filename, workspaceId) {
        if (!filename || filename.trim() === '') {
          log('‚ùå Empty filename in constructHashUrl', 'error');
          return null;
        }

        const cleanFilename = filename.replace(/^.*\//, '');
        if (!cleanFilename || cleanFilename.trim() === '') {
          log('‚ùå Invalid filename after cleaning', 'error');
          return null;
        }

        if (cleanFilename.length >= 10) {
          const hash1 = cleanFilename.substring(0, 3);
          const hash2 = cleanFilename.substring(3, 6);
          return `/api/files/${workspaceId}/${hash1}/${hash2}/${cleanFilename}`;
        }
        return `/api/files/${workspaceId}/${cleanFilename}`;
      }

      // Test cases
      const testCases = [
        {
          name: 'Complete file object',
          input: {
            file_url: '/api/files/2/60c/155/60c155658fcb1ef14145b5c9e359a571c504b8e1a7449d9965f720d3c1eebb68.png',
            filename: 'test.png'
          },
          expected: 'Should return existing /api/files/ URL'
        },
        {
          name: 'Hash filename only',
          input: '60c155658fcb1ef14145b5c9e359a571c504b8e1a7449d9965f720d3c1eebb68.png',
          expected: '/api/files/2/60c/155/...'
        },
        {
          name: 'Empty filename (bug case)',
          input: '',
          expected: 'Should return null, not /api/files/2/'
        }
      ];

      testCases.forEach(test => {
        const result = mockGetStandardFileUrl(test.input, { workspaceId: 2 });
        const isCorrect = result !== null && result.startsWith('/api/files/');

        log(`üß™ ${test.name}:`, 'info');
        log(`   Input: ${JSON.stringify(test.input)}`, 'info');
        log(`   Output: ${result}`, result ? 'success' : 'error');
        log(`   Expected: ${test.expected}`, 'info');
        log(`   Status: ${isCorrect ? '‚úÖ Correct /api/files/ format' : '‚ùå Wrong format'}`,
          isCorrect ? 'success' : 'error');
      });
    }

    function checkConsoleForFixes() {
      log('üîç Checking console for evidence of fix...', 'info');

      // Instructions for manual verification
      log('Please check browser console for these indicators:', 'info');
      log('‚úÖ URLs starting with /api/files/ instead of /files/', 'success');
      log('‚úÖ No more /files/2/ incomplete URLs', 'success');
      log('‚úÖ EnhancedImageThumbnail logging correct URLs', 'success');
      log('‚ùå If you still see /files/ URLs, the fix may need more time or refresh', 'warning');

      // Automatic console monitoring
      const originalConsoleLog = console.log;
      const originalConsoleError = console.error;

      let fixEvidence = 0;
      let legacyEvidence = 0;

      console.log = function (...args) {
        const message = args.join(' ');
        if (message.includes('/api/files/')) {
          fixEvidence++;
          log(`‚úÖ Console: Found /api/files/ URL in logs`, 'success');
        }
        if (message.includes('/files/2/') && !message.includes('/api/files/')) {
          legacyEvidence++;
          log(`‚ùå Console: Found legacy /files/ URL in logs`, 'error');
        }
        originalConsoleLog.apply(console, args);
      };

      console.error = function (...args) {
        const message = args.join(' ');
        if (message.includes('/files/2/') && !message.includes('/api/files/')) {
          legacyEvidence++;
          log(`‚ùå Console Error: Found legacy /files/ URL in error logs`, 'error');
        }
        originalConsoleError.apply(console, args);
      };

      // Restore after 10 seconds
      setTimeout(() => {
        console.log = originalConsoleLog;
        console.error = originalConsoleError;

        if (fixEvidence > legacyEvidence) {
          log('üéâ Console analysis: Fix is working! More /api/files/ than legacy URLs', 'success');
        } else if (legacyEvidence > 0) {
          log('‚ö†Ô∏è Console analysis: Still some legacy URLs detected', 'warning');
        } else {
          log('‚ÑπÔ∏è Console analysis: No clear evidence yet, may need more activity', 'info');
        }
      }, 10000);

      log('üïê Monitoring console for 10 seconds...', 'info');
    }

    // Auto-verify on page load
    window.addEventListener('load', () => {
      setTimeout(() => {
        log('üöÄ Auto-verification started...', 'info');
        verifyImageLoading();
      }, 2000);
    });
  </script>
</body>

</html>