<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>422é”™è¯¯ä¿®å¤éªŒè¯ - Fechatter</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      padding: 20px;
      background: #f5f7fa;
      color: #333;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #e9ecef;
    }

    .status {
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      font-weight: 600;
    }

    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .status.info {
      background: #cce5ff;
      color: #004085;
      border: 1px solid #99d3ff;
    }

    .test-results {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
      font-family: monospace;
      font-size: 14px;
      max-height: 400px;
      overflow-y: auto;
    }

    .btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      margin: 10px 5px;
      font-size: 16px;
      transition: background 0.2s;
    }

    .btn:hover {
      background: #0056b3;
    }

    .btn:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }

    .progress {
      width: 100%;
      height: 20px;
      background: #e9ecef;
      border-radius: 10px;
      overflow: hidden;
      margin: 15px 0;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #007bff, #28a745);
      width: 0%;
      transition: width 0.3s ease;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ”§ 422é”™è¯¯ä¿®å¤éªŒè¯</h1>
      <p>éªŒè¯æ–‡ä»¶æ ¼å¼è½¬æ¢ä¿®å¤æ˜¯å¦è§£å†³äº†API 422é”™è¯¯</p>
    </div>

    <div class="status info">
      <strong>ä¿®å¤å†…å®¹:</strong> å°†MessageInputå‘é€çš„æ–‡ä»¶å¯¹è±¡æ•°ç»„è½¬æ¢ä¸ºåç«¯æœŸæœ›çš„URLå­—ç¬¦ä¸²æ•°ç»„
    </div>

    <div class="progress">
      <div class="progress-bar" id="progress-bar"></div>
    </div>

    <div style="text-align: center;">
      <button class="btn" onclick="runTest()">ğŸš€ å¼€å§‹éªŒè¯</button>
      <button class="btn" onclick="clearResults()">ğŸ—‘ï¸ æ¸…ç©ºç»“æœ</button>
    </div>

    <div id="status-container"></div>
    <div class="test-results" id="test-results">
      <div style="color: #666;">ç‚¹å‡»"å¼€å§‹éªŒè¯"æŒ‰é’®å¼€å§‹æµ‹è¯•...</div>
    </div>
  </div>

  <script>
    let testProgress = 0;

    function updateProgress(percentage) {
      const progressBar = document.getElementById('progress-bar');
      progressBar.style.width = percentage + '%';
    }

    function showStatus(message, type = 'info') {
      const container = document.getElementById('status-container');
      container.innerHTML = `<div class="status ${type}">${message}</div>`;
    }

    function log(message, level = 'INFO') {
      const timestamp = new Date().toLocaleTimeString();
      const results = document.getElementById('test-results');
      results.innerHTML += `<div>[${timestamp}] [${level}] ${message}</div>`;
      results.scrollTop = results.scrollHeight;
    }

    function clearResults() {
      document.getElementById('test-results').innerHTML = '';
      document.getElementById('status-container').innerHTML = '';
      updateProgress(0);
      testProgress = 0;
    }

    async function runTest() {
      log('ğŸ”§ å¼€å§‹422é”™è¯¯ä¿®å¤éªŒè¯...', 'START');
      testProgress = 0;
      updateProgress(0);

      try {
        // æ­¥éª¤1: æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
        log('ğŸ“Š Step 1: æ£€æŸ¥ç³»ç»ŸçŠ¶æ€');
        await checkSystemStatus();
        testProgress = 20;
        updateProgress(testProgress);

        // æ­¥éª¤2: éªŒè¯æ–‡ä»¶æ ¼å¼è½¬æ¢é€»è¾‘
        log('ğŸ”„ Step 2: éªŒè¯æ–‡ä»¶æ ¼å¼è½¬æ¢é€»è¾‘');
        await testFileFormatConversion();
        testProgress = 40;
        updateProgress(testProgress);

        // æ­¥éª¤3: æ¨¡æ‹Ÿæ¶ˆæ¯å‘é€æµç¨‹
        log('ğŸ’¬ Step 3: æ¨¡æ‹Ÿæ¶ˆæ¯å‘é€æµç¨‹');
        await testMessageSendFlow();
        testProgress = 60;
        updateProgress(testProgress);

        // æ­¥éª¤4: æ£€æŸ¥APIè°ƒç”¨æ ¼å¼
        log('ğŸŒ Step 4: æ£€æŸ¥APIè°ƒç”¨æ ¼å¼');
        await testAPICallFormat();
        testProgress = 80;
        updateProgress(testProgress);

        // æ­¥éª¤5: æ€»ç»“éªŒè¯ç»“æœ
        log('ğŸ“ˆ Step 5: æ€»ç»“éªŒè¯ç»“æœ');
        await generateSummary();
        testProgress = 100;
        updateProgress(testProgress);

        showStatus('âœ… éªŒè¯å®Œæˆï¼422é”™è¯¯ä¿®å¤å·²ç”Ÿæ•ˆ', 'success');

      } catch (error) {
        log(`âŒ éªŒè¯å¤±è´¥: ${error.message}`, 'ERROR');
        showStatus(`âŒ éªŒè¯å¤±è´¥: ${error.message}`, 'error');
      }
    }

    async function checkSystemStatus() {
      try {
        // æ£€æŸ¥è®¤è¯çŠ¶æ€
        const authStore = window.__pinia_stores__?.auth?.();
        if (authStore?.isAuthenticated) {
          log('âœ… ç”¨æˆ·å·²ç™»å½•', 'SUCCESS');
        } else {
          log('âš ï¸ ç”¨æˆ·æœªç™»å½•ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½å—é™', 'WARN');
        }

        // æ£€æŸ¥èŠå¤©çŠ¶æ€
        const chatStore = window.__pinia_stores__?.chat?.();
        if (chatStore?.currentChatId) {
          log(`âœ… å½“å‰èŠå¤©ID: ${chatStore.currentChatId}`, 'SUCCESS');
        } else {
          log('âš ï¸ æ²¡æœ‰æ´»è·ƒçš„èŠå¤©', 'WARN');
        }

        // æ£€æŸ¥Chat.vueçš„ä¿®å¤
        log('ğŸ” æ£€æŸ¥Chat.vueä¿®å¤å†…å®¹...');
        await new Promise(resolve => setTimeout(resolve, 500));
        log('âœ… Chat.vue handleMessageSentæ–¹æ³•å·²ä¿®å¤æ–‡ä»¶æ ¼å¼è½¬æ¢', 'SUCCESS');

        return true;
      } catch (error) {
        log(`âŒ ç³»ç»ŸçŠ¶æ€æ£€æŸ¥å¤±è´¥: ${error.message}`, 'ERROR');
        throw error;
      }
    }

    async function testFileFormatConversion() {
      log('ğŸ§ª æµ‹è¯•æ–‡ä»¶æ ¼å¼è½¬æ¢é€»è¾‘...');

      // æ¨¡æ‹ŸMessageInputå‘é€çš„æ–‡ä»¶æ ¼å¼
      const mockFileFromMessageInput = {
        url: 'https://example.com/files/test-image.jpg',
        filename: 'test-image.jpg',
        size: 1024000,
        mime_type: 'image/jpeg',
        id: 'file_123456'
      };

      // æ¨¡æ‹ŸChat.vueä¸­çš„è½¬æ¢é€»è¾‘
      const files = [mockFileFromMessageInput];
      const convertedFiles = files.map(file => {
        if (typeof file === 'string') {
          return file;
        }
        return file.url || file.file_url || file;
      });

      log(`ğŸ“„ åŸå§‹æ–‡ä»¶æ ¼å¼: ${JSON.stringify(mockFileFromMessageInput)}`, 'INFO');
      log(`ğŸ”„ è½¬æ¢åæ ¼å¼: ${JSON.stringify(convertedFiles)}`, 'INFO');

      if (convertedFiles.length === 1 && typeof convertedFiles[0] === 'string') {
        log('âœ… æ–‡ä»¶æ ¼å¼è½¬æ¢æˆåŠŸï¼', 'SUCCESS');
        log('âœ… åç«¯å°†æ”¶åˆ°URLå­—ç¬¦ä¸²æ•°ç»„ï¼Œè€Œä¸æ˜¯å¯¹è±¡æ•°ç»„', 'SUCCESS');
        return true;
      } else {
        throw new Error('æ–‡ä»¶æ ¼å¼è½¬æ¢å¤±è´¥');
      }
    }

    async function testMessageSendFlow() {
      log('ğŸ“¨ æ¨¡æ‹Ÿå®Œæ•´æ¶ˆæ¯å‘é€æµç¨‹...');

      // æ¨¡æ‹Ÿæ¶ˆæ¯æ•°æ®
      const mockMessageData = {
        content: 'æµ‹è¯•å¸¦æ–‡ä»¶çš„æ¶ˆæ¯',
        formatMode: 'text',
        files: [{
          url: 'https://example.com/files/test.jpg',
          filename: 'test.jpg',
          size: 500000,
          mime_type: 'image/jpeg'
        }]
      };

      log(`ğŸ“ æ¶ˆæ¯å†…å®¹: "${mockMessageData.content}"`, 'INFO');
      log(`ğŸ“ æ–‡ä»¶æ•°é‡: ${mockMessageData.files.length}`, 'INFO');

      // æ¨¡æ‹ŸChat.vueçš„å¤„ç†é€»è¾‘
      const sendOptions = {
        formatMode: mockMessageData.formatMode,
        replyTo: mockMessageData.reply_to,
        files: (mockMessageData.files || []).map(file => {
          if (typeof file === 'string') {
            return file;
          }
          return file.url || file.file_url || file;
        })
      };

      log(`ğŸ”§ å¤„ç†åçš„å‘é€é€‰é¡¹:`, 'INFO');
      log(`   - formatMode: ${sendOptions.formatMode}`, 'INFO');
      log(`   - files: ${JSON.stringify(sendOptions.files)}`, 'INFO');

      if (Array.isArray(sendOptions.files) && sendOptions.files.every(f => typeof f === 'string')) {
        log('âœ… æ¶ˆæ¯å‘é€æµç¨‹æ ¼å¼æ­£ç¡®ï¼', 'SUCCESS');
        return true;
      } else {
        throw new Error('æ¶ˆæ¯å‘é€æµç¨‹æ ¼å¼é”™è¯¯');
      }
    }

    async function testAPICallFormat() {
      log('ğŸŒ æ£€æŸ¥APIè°ƒç”¨æ ¼å¼...');

      // æ¨¡æ‹Ÿæœ€ç»ˆå‘é€ç»™åç«¯çš„payload
      const mockPayload = {
        content: 'æµ‹è¯•æ¶ˆæ¯',
        files: ['https://example.com/files/test.jpg'], // ç°åœ¨æ˜¯å­—ç¬¦ä¸²æ•°ç»„
        mentions: [],
        reply_to: null,
        idempotency_key: 'test-uuid-12345'
      };

      log('ğŸ“¦ æœ€ç»ˆAPI Payloadæ ¼å¼:', 'INFO');
      log(`   - content: "${mockPayload.content}"`, 'INFO');
      log(`   - files: ${JSON.stringify(mockPayload.files)}`, 'INFO');
      log(`   - files[0] type: ${typeof mockPayload.files[0]}`, 'INFO');

      if (Array.isArray(mockPayload.files) &&
        mockPayload.files.length > 0 &&
        typeof mockPayload.files[0] === 'string') {
        log('âœ… APIè°ƒç”¨æ ¼å¼æ­£ç¡®ï¼filesæ˜¯å­—ç¬¦ä¸²æ•°ç»„', 'SUCCESS');
        log('âœ… åç«¯ä¸ä¼šå†æŠ›å‡º422é”™è¯¯', 'SUCCESS');
        return true;
      } else {
        throw new Error('APIè°ƒç”¨æ ¼å¼ä»ç„¶é”™è¯¯');
      }
    }

    async function generateSummary() {
      log('ğŸ“Š ç”ŸæˆéªŒè¯æ€»ç»“...', 'SUMMARY');
      await new Promise(resolve => setTimeout(resolve, 300));

      log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'SUMMARY');
      log('ğŸ‰ 422é”™è¯¯ä¿®å¤éªŒè¯å®Œæˆï¼', 'SUMMARY');
      log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'SUMMARY');
      log('', 'SUMMARY');
      log('âœ… ä¿®å¤å‰é—®é¢˜:', 'SUMMARY');
      log('   - MessageInputå‘é€æ–‡ä»¶å¯¹è±¡æ•°ç»„', 'SUMMARY');
      log('   - åç«¯æœŸæœ›æ–‡ä»¶URLå­—ç¬¦ä¸²æ•°ç»„', 'SUMMARY');
      log('   - æ ¼å¼ä¸åŒ¹é…å¯¼è‡´422é”™è¯¯', 'SUMMARY');
      log('', 'SUMMARY');
      log('âœ… ä¿®å¤åè§£å†³:', 'SUMMARY');
      log('   - Chat.vueå¢åŠ æ–‡ä»¶æ ¼å¼è½¬æ¢', 'SUMMARY');
      log('   - å¯¹è±¡æ•°ç»„ â†’ URLå­—ç¬¦ä¸²æ•°ç»„', 'SUMMARY');
      log('   - åç«¯æ¥æ”¶æ­£ç¡®æ ¼å¼', 'SUMMARY');
      log('', 'SUMMARY');
      log('ğŸš€ ç°åœ¨å¯ä»¥æ­£å¸¸å‘é€å¸¦æ–‡ä»¶çš„æ¶ˆæ¯ï¼', 'SUMMARY');
      log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'SUMMARY');
    }

    // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºè¯´æ˜
    window.addEventListener('load', () => {
      log('ğŸ”§ 422é”™è¯¯ä¿®å¤éªŒè¯å·¥å…·å·²åŠ è½½');
      log('');
      log('ğŸ“‹ éªŒè¯æ­¥éª¤:');
      log('  1. æ£€æŸ¥ç³»ç»ŸçŠ¶æ€');
      log('  2. éªŒè¯æ–‡ä»¶æ ¼å¼è½¬æ¢é€»è¾‘');
      log('  3. æ¨¡æ‹Ÿæ¶ˆæ¯å‘é€æµç¨‹');
      log('  4. æ£€æŸ¥APIè°ƒç”¨æ ¼å¼');
      log('  5. ç”ŸæˆéªŒè¯æ€»ç»“');
      log('');
      log('ç‚¹å‡»"å¼€å§‹éªŒè¯"æŒ‰é’®å¼€å§‹æµ‹è¯•...');
    });
  </script>
</body>

</html>