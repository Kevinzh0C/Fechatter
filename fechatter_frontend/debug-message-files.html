<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ” æ¶ˆæ¯æ–‡ä»¶é™„ä»¶è°ƒè¯•å·¥å…·</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0;
      padding: 20px;
      color: #333;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .debug-section {
      background: #f8f9fa;
      border: 2px solid #e9ecef;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .debug-section h3 {
      color: #495057;
      margin-top: 0;
    }

    .code-block {
      background: #2d3748;
      color: #e2e8f0;
      padding: 15px;
      border-radius: 8px;
      font-family: 'Monaco', 'Consolas', monospace;
      font-size: 12px;
      white-space: pre-wrap;
      overflow-x: auto;
    }

    .btn {
      background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      margin: 10px 5px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(79, 70, 229, 0.3);
    }

    .status {
      padding: 10px;
      border-radius: 6px;
      margin: 10px 0;
      font-weight: 600;
    }

    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .status.warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ” æ¶ˆæ¯æ–‡ä»¶é™„ä»¶è°ƒè¯•å·¥å…·</h1>
      <p>æ£€æŸ¥æ¶ˆæ¯178çš„fileså­—æ®µå’Œæ–‡ä»¶é™„ä»¶æ¸²æŸ“çŠ¶æ€</p>
    </div>

    <div class="debug-section">
      <h3>ğŸ¯ å¿«é€Ÿè¯Šæ–­</h3>
      <button class="btn" onclick="quickDiagnose()">å¿«é€Ÿè¯Šæ–­æ¶ˆæ¯178</button>
      <button class="btn" onclick="checkUnifiedMessageService()">æ£€æŸ¥UnifiedMessageService</button>
      <button class="btn" onclick="checkChatStore()">æ£€æŸ¥ChatStore</button>
      <div id="quickResults"></div>
    </div>

    <div class="debug-section">
      <h3>ğŸ“¨ æ¶ˆæ¯178è¯¦ç»†ä¿¡æ¯</h3>
      <button class="btn" onclick="analyzeMessage178()">åˆ†ææ¶ˆæ¯178</button>
      <div id="message178Results"></div>
    </div>

    <div class="debug-section">
      <h3>ğŸ—ƒï¸ æ‰€æœ‰æ¶ˆæ¯æ¦‚è§ˆ</h3>
      <button class="btn" onclick="listAllMessages()">åˆ—å‡ºèŠå¤©2çš„æ‰€æœ‰æ¶ˆæ¯</button>
      <div id="allMessagesResults"></div>
    </div>

    <div class="debug-section">
      <h3>ğŸ”§ æ–‡ä»¶é™„ä»¶æ¸²æŸ“æ£€æŸ¥</h3>
      <button class="btn" onclick="checkFileRendering()">æ£€æŸ¥æ–‡ä»¶æ¸²æŸ“ç»„ä»¶</button>
      <button class="btn" onclick="simulateFileMessage()">æ¨¡æ‹Ÿæ–‡ä»¶æ¶ˆæ¯</button>
      <div id="fileRenderingResults"></div>
    </div>

    <div class="debug-section">
      <h3>ğŸ’Š ä¿®å¤å·¥å…·</h3>
      <button class="btn" onclick="fixMessage178()">ä¿®å¤æ¶ˆæ¯178æ–‡ä»¶å­—æ®µ</button>
      <button class="btn" onclick="refreshMessages()">åˆ·æ–°æ¶ˆæ¯åˆ—è¡¨</button>
      <div id="fixResults"></div>
    </div>
  </div>

  <script>
    // å¿«é€Ÿè¯Šæ–­å‡½æ•°
    function quickDiagnose() {
      const results = document.getElementById('quickResults');
      results.innerHTML = '<div class="status">ğŸ” æ­£åœ¨è¯Šæ–­...</div>';

      try {
        // æ£€æŸ¥æ˜¯å¦æœ‰å¿…è¦çš„å…¨å±€å¯¹è±¡
        const checks = {
          unifiedMessageService: typeof window.unifiedMessageService !== 'undefined',
          chatStore: typeof window.useChatStore !== 'undefined' || typeof window.$pinia !== 'undefined',
          vue: typeof window.Vue !== 'undefined' || typeof window.__VUE__ !== 'undefined'
        };

        // å°è¯•è·å–æ¶ˆæ¯178
        let message178 = null;
        let messagesInChat2 = null;

        if (window.unifiedMessageService) {
          messagesInChat2 = window.unifiedMessageService.getMessagesForChat(2);
          if (messagesInChat2) {
            message178 = messagesInChat2.find(m => m.id === 178 || m.id === '178');
          }
        }

        const diagnosis = {
          globalObjects: checks,
          chat2Messages: messagesInChat2 ? messagesInChat2.length : 'N/A',
          message178Found: !!message178,
          message178HasFiles: message178 ? !!(message178.files && message178.files.length > 0) : false,
          message178FilesCount: message178 ? (message178.files ? message178.files.length : 0) : 'N/A'
        };

        let status = 'success';
        let summary = 'âœ… ç³»ç»Ÿæ­£å¸¸';

        if (!message178) {
          status = 'error';
          summary = 'âŒ æ‰¾ä¸åˆ°æ¶ˆæ¯178';
        } else if (!diagnosis.message178HasFiles) {
          status = 'warning';
          summary = 'âš ï¸ æ¶ˆæ¯178å­˜åœ¨ä½†æ²¡æœ‰fileså­—æ®µ';
        }

        results.innerHTML = `
                    <div class="status ${status}">${summary}</div>
                    <div class="code-block">${JSON.stringify(diagnosis, null, 2)}</div>
                    ${message178 ? `<div class="code-block">æ¶ˆæ¯178å†…å®¹ï¼š\n${JSON.stringify(message178, null, 2)}</div>` : ''}
                `;

      } catch (error) {
        results.innerHTML = `
                    <div class="status error">âŒ è¯Šæ–­å¤±è´¥: ${error.message}</div>
                    <div class="code-block">${error.stack}</div>
                `;
      }
    }

    // æ£€æŸ¥UnifiedMessageService
    function checkUnifiedMessageService() {
      const results = document.getElementById('quickResults');

      try {
        if (!window.unifiedMessageService) {
          results.innerHTML = '<div class="status error">âŒ UnifiedMessageServiceæœªæ‰¾åˆ°</div>';
          return;
        }

        const service = window.unifiedMessageService;
        const chat2Messages = service.getMessagesForChat(2);

        const serviceInfo = {
          available: true,
          chat2MessagesCount: chat2Messages ? chat2Messages.length : 0,
          allChats: Array.from(service.messagesByChat.keys()),
          hasChat2: service.messagesByChat.has(2),
          recentMessages: chat2Messages ? chat2Messages.slice(-3).map(m => ({
            id: m.id,
            content: m.content ? m.content.substring(0, 50) : '(empty)',
            hasFiles: !!(m.files && m.files.length > 0),
            filesCount: m.files ? m.files.length : 0
          })) : []
        };

        results.innerHTML = `
                    <div class="status success">âœ… UnifiedMessageServiceæ­£å¸¸</div>
                    <div class="code-block">${JSON.stringify(serviceInfo, null, 2)}</div>
                `;

      } catch (error) {
        results.innerHTML = `
                    <div class="status error">âŒ æ£€æŸ¥å¤±è´¥: ${error.message}</div>
                `;
      }
    }

    // åˆ†ææ¶ˆæ¯178
    function analyzeMessage178() {
      const results = document.getElementById('message178Results');
      results.innerHTML = '<div class="status">ğŸ” æ­£åœ¨åˆ†ææ¶ˆæ¯178...</div>';

      try {
        if (!window.unifiedMessageService) {
          results.innerHTML = '<div class="status error">âŒ UnifiedMessageServiceæœªæ‰¾åˆ°</div>';
          return;
        }

        const messages = window.unifiedMessageService.getMessagesForChat(2);
        const message178 = messages ? messages.find(m => m.id === 178 || m.id === '178') : null;

        if (!message178) {
          results.innerHTML = '<div class="status error">âŒ æ‰¾ä¸åˆ°æ¶ˆæ¯178</div>';
          return;
        }

        const analysis = {
          basicInfo: {
            id: message178.id,
            temp_id: message178.temp_id,
            content: message178.content,
            sender_name: message178.sender_name,
            created_at: message178.created_at,
            status: message178.status
          },
          filesInfo: {
            hasFiles: !!(message178.files),
            filesCount: message178.files ? message178.files.length : 0,
            filesArray: message178.files || [],
            filesType: typeof message178.files,
            filesIsArray: Array.isArray(message178.files)
          },
          fullMessage: message178
        };

        let status = 'success';
        let summary = 'âœ… æ¶ˆæ¯178åˆ†æå®Œæˆ';

        if (!message178.files || message178.files.length === 0) {
          status = 'warning';
          summary = 'âš ï¸ æ¶ˆæ¯178æ²¡æœ‰æ–‡ä»¶é™„ä»¶';
        }

        results.innerHTML = `
                    <div class="status ${status}">${summary}</div>
                    <div class="code-block">åŸºç¡€ä¿¡æ¯ï¼š\n${JSON.stringify(analysis.basicInfo, null, 2)}</div>
                    <div class="code-block">æ–‡ä»¶ä¿¡æ¯ï¼š\n${JSON.stringify(analysis.filesInfo, null, 2)}</div>
                    <div class="code-block">å®Œæ•´æ¶ˆæ¯ï¼š\n${JSON.stringify(analysis.fullMessage, null, 2)}</div>
                `;

      } catch (error) {
        results.innerHTML = `
                    <div class="status error">âŒ åˆ†æå¤±è´¥: ${error.message}</div>
                `;
      }
    }

    // åˆ—å‡ºæ‰€æœ‰æ¶ˆæ¯
    function listAllMessages() {
      const results = document.getElementById('allMessagesResults');
      results.innerHTML = '<div class="status">ğŸ” æ­£åœ¨è·å–æ‰€æœ‰æ¶ˆæ¯...</div>';

      try {
        if (!window.unifiedMessageService) {
          results.innerHTML = '<div class="status error">âŒ UnifiedMessageServiceæœªæ‰¾åˆ°</div>';
          return;
        }

        const messages = window.unifiedMessageService.getMessagesForChat(2) || [];

        const messagesSummary = messages.map(m => ({
          id: m.id,
          temp_id: m.temp_id,
          content: m.content ? m.content.substring(0, 30) + '...' : '(empty)',
          sender: m.sender_name,
          hasFiles: !!(m.files && m.files.length > 0),
          filesCount: m.files ? m.files.length : 0,
          files: m.files ? m.files.map(f => ({
            filename: f.filename,
            url: f.url,
            size: f.size
          })) : [],
          status: m.status,
          isOptimistic: m.isOptimistic
        }));

        results.innerHTML = `
                    <div class="status success">âœ… æ‰¾åˆ°${messages.length}æ¡æ¶ˆæ¯</div>
                    <div class="code-block">${JSON.stringify(messagesSummary, null, 2)}</div>
                `;

      } catch (error) {
        results.innerHTML = `
                    <div class="status error">âŒ è·å–å¤±è´¥: ${error.message}</div>
                `;
      }
    }

    // æ£€æŸ¥æ–‡ä»¶æ¸²æŸ“
    function checkFileRendering() {
      const results = document.getElementById('fileRenderingResults');
      results.innerHTML = '<div class="status">ğŸ” æ£€æŸ¥æ–‡ä»¶æ¸²æŸ“ç»„ä»¶...</div>';

      try {
        // æ£€æŸ¥DOMä¸­æ˜¯å¦æœ‰DiscordMessageItemå…ƒç´ 
        const messageItems = document.querySelectorAll('[data-message-id="178"]');
        const allMessageItems = document.querySelectorAll('.discord-message-item');
        const filePreviewElements = document.querySelectorAll('.file-preview-container');

        const renderingInfo = {
          message178Elements: messageItems.length,
          allMessageElements: allMessageItems.length,
          filePreviewElements: filePreviewElements.length,
          message178Content: Array.from(messageItems).map(el => ({
            innerHTML: el.innerHTML.substring(0, 200) + '...',
            hasFilePreview: el.querySelector('.file-preview-container') !== null,
            hasMessageFiles: el.querySelector('.message-files') !== null
          }))
        };

        results.innerHTML = `
                    <div class="status success">âœ… DOMæ£€æŸ¥å®Œæˆ</div>
                    <div class="code-block">${JSON.stringify(renderingInfo, null, 2)}</div>
                `;

      } catch (error) {
        results.innerHTML = `
                    <div class="status error">âŒ æ£€æŸ¥å¤±è´¥: ${error.message}</div>
                `;
      }
    }

    // ä¿®å¤æ¶ˆæ¯178
    function fixMessage178() {
      const results = document.getElementById('fixResults');
      results.innerHTML = '<div class="status">ğŸ”§ æ­£åœ¨ä¿®å¤æ¶ˆæ¯178...</div>';

      try {
        if (!window.unifiedMessageService) {
          results.innerHTML = '<div class="status error">âŒ UnifiedMessageServiceæœªæ‰¾åˆ°</div>';
          return;
        }

        const messages = window.unifiedMessageService.getMessagesForChat(2);
        const message178 = messages ? messages.find(m => m.id === 178 || m.id === '178') : null;

        if (!message178) {
          results.innerHTML = '<div class="status error">âŒ æ‰¾ä¸åˆ°æ¶ˆæ¯178</div>';
          return;
        }

        // æ£€æŸ¥æ˜¯å¦éœ€è¦ä¿®å¤fileså­—æ®µ
        if (!message178.files || message178.files.length === 0) {
          // å°è¯•æ·»åŠ fileså­—æ®µï¼ˆåŸºäºä¸Šä¼ æ—¥å¿—ä¸­çš„ä¿¡æ¯ï¼‰
          message178.files = [{
            id: 1750792726974,
            filename: 'bubble_concept_fluid_1.png',
            url: '/files/60c155658fcb1ef14145b5c9e359a571c504b8e1a7449d9965f720d3c1eebb68.png',
            mime_type: 'image/png',
            size: 1124883
          }];

          // æ›´æ–°æ¶ˆæ¯
          window.unifiedMessageService.messagesByChat.set(2, messages);

          results.innerHTML = `
                        <div class="status success">âœ… å·²ä¿®å¤æ¶ˆæ¯178çš„fileså­—æ®µ</div>
                        <div class="code-block">ä¿®å¤åçš„æ¶ˆæ¯ï¼š\n${JSON.stringify(message178, null, 2)}</div>
                    `;
        } else {
          results.innerHTML = `
                        <div class="status warning">âš ï¸ æ¶ˆæ¯178å·²æœ‰fileså­—æ®µï¼Œæ— éœ€ä¿®å¤</div>
                        <div class="code-block">å½“å‰filesï¼š\n${JSON.stringify(message178.files, null, 2)}</div>
                    `;
        }

      } catch (error) {
        results.innerHTML = `
                    <div class="status error">âŒ ä¿®å¤å¤±è´¥: ${error.message}</div>
                `;
      }
    }

    // åˆ·æ–°æ¶ˆæ¯åˆ—è¡¨
    function refreshMessages() {
      const results = document.getElementById('fixResults');
      results.innerHTML = '<div class="status">ğŸ”„ æ­£åœ¨åˆ·æ–°æ¶ˆæ¯åˆ—è¡¨...</div>';

      try {
        // è§¦å‘Vueé‡æ–°æ¸²æŸ“
        if (window.Vue && window.Vue.nextTick) {
          window.Vue.nextTick(() => {
            results.innerHTML = '<div class="status success">âœ… æ¶ˆæ¯åˆ—è¡¨å·²åˆ·æ–°</div>';
          });
        } else {
          // ç®€å•çš„DOMåˆ·æ–°
          setTimeout(() => {
            results.innerHTML = '<div class="status success">âœ… é¡µé¢å·²åˆ·æ–°</div>';
            window.location.reload();
          }, 1000);
        }

      } catch (error) {
        results.innerHTML = `
                    <div class="status error">âŒ åˆ·æ–°å¤±è´¥: ${error.message}</div>
                `;
      }
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œå¿«é€Ÿè¯Šæ–­
    window.addEventListener('load', () => {
      setTimeout(quickDiagnose, 1000);
    });
  </script>
</body>

</html>