# Fechatter é¡¹ç›®ç»¼åˆæŒ‡å—

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

Fechatter æ˜¯ä¸€ä¸ªç°ä»£åŒ–çš„ä¼ä¸šçº§èŠå¤©åº”ç”¨ï¼Œé‡‡ç”¨ Rust æ„å»ºï¼Œæ”¯æŒå®æ—¶æ¶ˆæ¯ã€æœç´¢åŠŸèƒ½å’Œäº‹ä»¶é©±åŠ¨æ¶æ„ã€‚æœ¬æ–‡æ¡£æ•´åˆäº†é¡¹ç›®çš„æ¶æ„è®¾è®¡ã€ä¼˜åŒ–æ–¹æ¡ˆã€å®ç°è®¡åˆ’å’Œæœ€ä½³å®è·µã€‚

## ğŸ¯ é¡¹ç›®ç›®æ ‡ä¸æˆæœ

### æ ¸å¿ƒç›®æ ‡
- æ”¯æŒ 200äºº DAU çš„ä¼ä¸šçº§èŠå¤©åº”ç”¨
- å®ç°é«˜æ€§èƒ½ã€é«˜å¯ç”¨çš„æ¶ˆæ¯ç³»ç»Ÿ
- å»ºç«‹å¯æ‰©å±•çš„å¾®æœåŠ¡æ¶æ„
- ç¬¦åˆ Rust æœ€ä½³å®è·µçš„ä»£ç è´¨é‡

### å·²è¾¾æˆæˆæœ
- âœ… **æ€§èƒ½ä¼˜åŒ–**: é…ç½®é€‚é…200äººDAUï¼Œæ¶ˆæ¯å¤„ç†å»¶è¿Ÿä»5ç§’é™è‡³1ç§’
- âœ… **æ¶æ„é‡æ„**: å»ºç«‹æ¸…æ™°çš„Repository â†’ Service â†’ Handleråˆ†å±‚
- âœ… **ç”Ÿäº§å°±ç»ª**: å®Œæ•´çš„å¥åº·æ£€æŸ¥ä½“ç³»ï¼Œæ”¯æŒå®¹å™¨ç¼–æ’

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æŠ€æœ¯æ ˆ
- **åç«¯**: Rust + Axum æ¡†æ¶
- **æ•°æ®åº“**: PostgreSQL + SQLx
- **æ¶ˆæ¯é˜Ÿåˆ—**: NATS JetStream
- **æœç´¢å¼•æ“**: Meilisearch
- **è®¤è¯**: JWT (JSON Web Tokens)
- **å®æ—¶é€šä¿¡**: Server-Sent Events (SSE)
- **å®¹å™¨åŒ–**: Docker + Kubernetes

### é¡¹ç›®ç»“æ„
```
fechatter/
â”œâ”€â”€ fechatter_core/         # æ ¸å¿ƒé€»è¾‘å’Œå…±äº«åŠŸèƒ½
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ models/         # æ•°æ®æ¨¡å‹å’Œä¸šåŠ¡é€»è¾‘
â”‚       â”œâ”€â”€ traits/         # Repository å’Œ Service traits
â”‚       â””â”€â”€ errors/         # é”™è¯¯å®šä¹‰
â”œâ”€â”€ fechatter_server/       # ä¸»èŠå¤©åº”ç”¨æœåŠ¡å™¨
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ handlers/       # HTTP è¯·æ±‚å¤„ç†å™¨
â”‚       â”œâ”€â”€ middlewares/    # HTTP ä¸­é—´ä»¶ç»„ä»¶
â”‚       â”œâ”€â”€ models/         # æ•°æ®æ¨¡å‹å’Œæ•°æ®åº“äº¤äº’
â”‚       â”œâ”€â”€ services/       # ä¸šåŠ¡é€»è¾‘æœåŠ¡
â”‚       â”œâ”€â”€ utils/          # å·¥å…·å‡½æ•°
â”‚       â”œâ”€â”€ tests/          # é›†æˆå’Œå•å…ƒæµ‹è¯•
â”‚       â”œâ”€â”€ config.rs       # é…ç½®ç®¡ç†
â”‚       â”œâ”€â”€ error.rs        # é”™è¯¯å¤„ç†
â”‚       â””â”€â”€ main.rs         # åº”ç”¨å…¥å£ç‚¹
â”œâ”€â”€ notify_server/          # é€šçŸ¥æœåŠ¡
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ config.rs       # é€šçŸ¥æœåŠ¡é…ç½®
â”‚       â”œâ”€â”€ notify.rs       # æ ¸å¿ƒé€šçŸ¥é€»è¾‘
â”‚       â”œâ”€â”€ sse.rs          # Server-Sent Events å®ç°
â”‚       â””â”€â”€ main.rs         # é€šçŸ¥æœåŠ¡å…¥å£ç‚¹
â”œâ”€â”€ migrations/             # æ•°æ®åº“è¿ç§»æ–‡ä»¶
â””â”€â”€ docs/                   # é¡¹ç›®æ–‡æ¡£
```

### å½“å‰æ¶æ„ç»„ä»¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    fechatter_core                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Repository    â”‚  â”‚    Service      â”‚  â”‚    Models    â”‚ â”‚
â”‚  â”‚    Traits       â”‚  â”‚    Traits       â”‚  â”‚     DTOs     â”‚ â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚   Business   â”‚ â”‚
â”‚  â”‚ â€¢ UserRepo      â”‚  â”‚ â€¢ AuthService   â”‚  â”‚    Logic     â”‚ â”‚
â”‚  â”‚ â€¢ MessageRepo   â”‚  â”‚ â€¢ MessageSvc    â”‚  â”‚              â”‚ â”‚
â”‚  â”‚ â€¢ ChatRepo      â”‚  â”‚ â€¢ ChatService   â”‚  â”‚              â”‚ â”‚
â”‚  â”‚ â€¢ MemberRepo    â”‚  â”‚ â€¢ MemberSvc     â”‚  â”‚              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  fechatter_server                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Repository    â”‚  â”‚    Service      â”‚  â”‚   Handlers   â”‚ â”‚
â”‚  â”‚     Impls       â”‚  â”‚     Impls       â”‚  â”‚  (HTTP API)  â”‚ â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚              â”‚ â”‚
â”‚  â”‚ â€¢ PgUserRepo    â”‚  â”‚ â€¢ AuthSvcImpl   â”‚  â”‚ â€¢ auth/*     â”‚ â”‚
â”‚  â”‚ â€¢ PgMessageRepo â”‚  â”‚ â€¢ MessageImpl   â”‚  â”‚ â€¢ chat/*     â”‚ â”‚
â”‚  â”‚ â€¢ PgChatRepo    â”‚  â”‚ â€¢ ChatImpl      â”‚  â”‚ â€¢ message/*  â”‚ â”‚
â”‚  â”‚ â€¢ PgMemberRepo  â”‚  â”‚ â€¢ MemberImpl    â”‚  â”‚ â€¢ health/*   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  ServiceProviderâ”‚  â”‚  EventPublisher â”‚  â”‚ Middlewares  â”‚ â”‚
â”‚  â”‚   (DI Container)â”‚  â”‚   (NATS/Events) â”‚  â”‚   (Authç­‰)   â”‚ â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚              â”‚ â”‚
â”‚  â”‚ â€¢ All Repos     â”‚  â”‚ â€¢ Message Eventsâ”‚  â”‚ â€¢ AuthMW     â”‚ â”‚
â”‚  â”‚ â€¢ All Services  â”‚  â”‚ â€¢ Chat Events   â”‚  â”‚ â€¢ WorkspaceMWâ”‚ â”‚
â”‚  â”‚ â€¢ Dependencies  â”‚  â”‚ â€¢ Search Events â”‚  â”‚ â€¢ ChatMW     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¶ˆæ¯æµç¨‹

#### å½“å‰å®ç°
```
ç”¨æˆ·å‘é€æ¶ˆæ¯ â†’ PostgreSQLå­˜å‚¨ â†’ PostgreSQL NOTIFY
                    â†“
              notify_serverç›‘å¬
                    â†“
              SSEæ¨é€ç»™å®¢æˆ·ç«¯
```

#### æœªæ¥æ¶æ„ (NATSé›†æˆ)
```
ç”¨æˆ·å‘é€æ¶ˆæ¯ â†’ PostgreSQLå­˜å‚¨ â†’ ç«‹å³è¿”å›
                    â†“ (å¼‚æ­¥)
                NATSäº‹ä»¶å‘å¸ƒ
                    â†“ (1ç§’å†…)
          Meilisearchæ‰¹é‡ç´¢å¼•(10æ¡/æ‰¹)
                    â†“
              å®æ—¶é€šçŸ¥æ¨é€
```

## ğŸ’¬ èŠå¤©åŠŸèƒ½

### èŠå¤©ç±»å‹
Fechatter æ”¯æŒå››ç§ä¸åŒçš„èŠå¤©ç±»å‹ï¼Œæ¯ç§éƒ½æœ‰ç‰¹å®šçš„æˆå‘˜è§„åˆ™ï¼š

1. **å•èŠ (Single Chat)**: ä¸¤ä¸ªç”¨æˆ·ä¹‹é—´çš„ä¸€å¯¹ä¸€ç§äººå¯¹è¯
   - å¿…é¡»æ°å¥½æœ‰ä¸¤ä¸ªæˆå‘˜
   - ä¸èƒ½ä¸è‡ªå·±åˆ›å»ºå•èŠ

2. **ç¾¤èŠ (Group Chat)**: å¤šç”¨æˆ·å¯¹è¯
   - è‡³å°‘éœ€è¦ä¸‰ä¸ªæˆå‘˜ï¼ˆåŒ…æ‹¬åˆ›å»ºè€…ï¼‰
   - æ‰€æœ‰æˆå‘˜éƒ½å¯ä»¥å‘é€æ¶ˆæ¯

3. **ç§æœ‰é¢‘é“ (Private Channel)**: ä»…é‚€è¯·çš„ä¸»é¢˜é¢‘é“
   - åˆ›å»ºè€…è‡ªåŠ¨æˆä¸ºæˆå‘˜
   - å¯é€šè¿‡é‚€è¯·æ·»åŠ å…¶ä»–æˆå‘˜

4. **å…¬å…±é¢‘é“ (Public Channel)**: å¼€æ”¾çš„ä¸»é¢˜é¢‘é“
   - åˆå§‹æ—¶åªæœ‰åˆ›å»ºè€…ä½œä¸ºæˆå‘˜
   - ç”¨æˆ·å¯ä»¥æ— éœ€é‚€è¯·ç›´æ¥åŠ å…¥

### æ ¸å¿ƒåŠŸèƒ½
- âœ… **å¤šç§èŠå¤©ç±»å‹**: å•èŠã€ç¾¤èŠã€ç§æœ‰é¢‘é“ã€å…¬å…±é¢‘é“
- âœ… **å·¥ä½œç©ºé—´ç®¡ç†**: å¤šç§Ÿæˆ·æ¶æ„ï¼Œç»„ç»‡éš”ç¦»çš„å·¥ä½œç©ºé—´
- âœ… **JWTè®¤è¯**: å®‰å…¨çš„ç”¨æˆ·è®¤è¯å’Œåˆ·æ–°ä»¤ç‰Œæ”¯æŒ
- âœ… **å®æ—¶æ¶ˆæ¯**: Server-Sent Events (SSE) å®æ—¶é€šçŸ¥å’Œæ¶ˆæ¯ä¼ é€’
- âœ… **RESTful API**: èŠå¤©ã€ç”¨æˆ·å’Œå·¥ä½œç©ºé—´ç®¡ç†çš„ç»¼åˆAPI
- âœ… **PostgreSQLæ•°æ®åº“**: å¯é çš„æ•°æ®æŒä¹…åŒ–å’Œé«˜æ•ˆçš„æ¨¡å¼è®¾è®¡
- âœ… **å…¨é¢é”™è¯¯å¤„ç†**: åº”ç”¨ç¨‹åºä¸­çš„å¼ºå¤§é”™è¯¯ç®¡ç†
- âœ… **æ¨¡å—åŒ–æ¶æ„**: èŠå¤©åŠŸèƒ½å’Œé€šçŸ¥ä¼ é€’ä¹‹é—´çš„å…³æ³¨ç‚¹åˆ†ç¦»

## ğŸ”Œ API ç«¯ç‚¹

### è®¤è¯ç›¸å…³
- `POST /api/signin` - ç™»å½•å¹¶è·å–JWTä»¤ç‰Œ
- `POST /api/signup` - æ³¨å†Œæ–°ç”¨æˆ·
- `POST /api/refresh` - åˆ·æ–°è®¤è¯ä»¤ç‰Œ
- `POST /api/logout` - ç™»å‡ºå¹¶ä½¿ä»¤ç‰Œå¤±æ•ˆ

### èŠå¤©ç®¡ç†
- `GET /api/chat` - åˆ—å‡ºè®¤è¯ç”¨æˆ·çš„æ‰€æœ‰èŠå¤©
- `POST /api/chat` - åˆ›å»ºæ–°èŠå¤©
- `PATCH /api/chat/{id}` - æ›´æ–°èŠå¤©è¯¦æƒ…
- `DELETE /api/chat/{id}` - åˆ é™¤èŠå¤©

### èŠå¤©æˆå‘˜
- `GET /api/chat/{id}/members` - åˆ—å‡ºèŠå¤©æˆå‘˜
- `POST /api/chat/{id}/members` - å‘èŠå¤©æ·»åŠ æˆå‘˜
- `DELETE /api/chat/{id}/members` - ä»èŠå¤©ä¸­ç§»é™¤æˆå‘˜
- `PATCH /api/chat/{id}/members/{member_id}` - è½¬ç§»èŠå¤©æ‰€æœ‰æƒ

### æ¶ˆæ¯ç›¸å…³
- `GET /api/chat/{id}/messages` - è·å–èŠå¤©æ¶ˆæ¯
- `POST /api/chat/{id}/messages` - å‘é€æ–°æ¶ˆæ¯
- `GET /api/search/messages` - æœç´¢æ¶ˆæ¯

### å·¥ä½œç©ºé—´
- `GET /api/users` - åˆ—å‡ºå·¥ä½œç©ºé—´ä¸­çš„æ‰€æœ‰ç”¨æˆ·

### å¥åº·æ£€æŸ¥
- `GET /health` - è¯¦ç»†å¥åº·çŠ¶æ€æ£€æŸ¥
- `GET /health/simple` - ç®€å•å¥åº·æ£€æŸ¥ (K8s probe)

## ğŸš€ æ€§èƒ½ä¼˜åŒ–æˆæœ

### é…ç½®ä¼˜åŒ–
```yaml
# ä¼˜åŒ–å‰ (è¿‡åº¦è®¾è®¡)
async_indexing:
  batch_size: 50        # é€‚ç”¨1000+ DAU
  batch_timeout_ms: 5000  # 5ç§’å»¶è¿Ÿ

# ä¼˜åŒ–å (200äººDAUé€‚é…)
async_indexing:
  batch_size: 10        # 200äººDAUé€‚é…
  batch_timeout_ms: 1000  # 1ç§’å®æ—¶ä½“éªŒ
```

### æ•°æ®åº“ä¼˜åŒ–
```rust
// ä¿®å¤å‰ (ä½æ•ˆçš„æ•°ç»„æŸ¥è¯¢)
sqlx::query_scalar::<_, i64>("SELECT unnest(chat_members) FROM chats WHERE id = $1")

// ä¿®å¤å (é«˜æ•ˆçš„å…³ç³»è¡¨æŸ¥è¯¢)
sqlx::query_scalar::<_, i64>("SELECT user_id FROM chat_members WHERE chat_id = $1")
```

### æ€§èƒ½æŒ‡æ ‡
- **æ¶ˆæ¯å‘é€**: <100ms å“åº”æ—¶é—´
- **æœç´¢å»¶è¿Ÿ**: 1ç§’å†…ç´¢å¼•å®Œæˆ
- **å®æ—¶é€šçŸ¥**: SSEæ¨é€ï¼Œä½å»¶è¿Ÿ
- **å¹¶å‘å¤„ç†**: æ”¯æŒ200äººåŒæ—¶åœ¨çº¿

## ğŸ”§ ä»£ç è´¨é‡ä¼˜åŒ–

### ç¼–è¯‘è­¦å‘Šæ¸…ç†
**ä¼˜åŒ–å‰**: 13ä¸ªç¼–è¯‘è­¦å‘Š
**ä¼˜åŒ–å**: 0ä¸ªç¼–è¯‘è­¦å‘Š

#### æ¸…ç†å†…å®¹
- âœ… ç§»é™¤ 11ä¸ª unused imports
- âœ… åˆ é™¤ unused structs: `UploadPayload`, `ErrOutput`
- âœ… åˆ é™¤ unused functions: `get_affected_chat_user_ids`, `validate_refresh_token`
- âœ… ç§»é™¤ deprecated `ServiceFactory` pattern

### Idiomatic Rust æ”¹è¿›
```rust
// âŒ ä¼˜åŒ–å‰ - è¿‡åº¦æŠ½è±¡
#[deprecated = "Consider using direct service creation instead"]
pub trait ServiceFactory {
    type Service;
    fn create(provider: &ServiceProvider) -> Self::Service;
}

// âœ… ä¼˜åŒ–å - ç›´æ¥æœåŠ¡åˆ›å»º
impl ActualAuthServiceProvider for AppState {
    fn create_service(&self) -> Self::AuthService {
        AuthService::new(user_repository, token_service, refresh_token_repository)
    }
}
```

### é”™è¯¯å¤„ç†ç»Ÿä¸€
```rust
// âœ… ä½¿ç”¨å®Œå…¨é™å®šè¯­æ³•ç¡®ä¿ç±»å‹å®‰å…¨
pub async fn signup(&self, payload: &CreateUser) -> Result<AuthTokens, CoreError> {
    use fechatter_core::SignupService;
    <Self as ActualAuthServiceProvider>::create_service(self)
        .signup(payload, auth_context)
        .await
}
```

## ğŸ¥ å¥åº·æ£€æŸ¥ç³»ç»Ÿ

### è®¾è®¡ç†å¿µ
å³ä½¿200äººDAUçš„å°è§„æ¨¡åº”ç”¨ä¹Ÿéœ€è¦å¥åº·æ£€æŸ¥ï¼ŒåŸå› ï¼š
- **æœåŠ¡å‘ç°**: Kubernetes liveness/readiness probe
- **ä¾èµ–ç›‘æ§**: æ¯”äº‘ç›‘æ§æ›´ç²¾ç¡®çš„åº”ç”¨çº§æ£€æŸ¥
- **è‡ªåŠ¨æ¢å¤**: æ”¯æŒå®¹å™¨è‡ªåŠ¨é‡å¯

### å®ç°æ¶æ„
```rust
#[async_trait]
pub trait HealthChecker: Send + Sync {
    async fn check_health(&self) -> ServiceHealth;
    fn service_name(&self) -> &'static str;
}

// å…·ä½“å®ç°
pub struct DatabaseHealthChecker {
    pool: Arc<PgPool>,
}

pub struct NatsHealthChecker {
    client: Option<async_nats::Client>,
}

pub struct MeilisearchHealthChecker {
    client: Option<MeilisearchClient>,
}
```

### APIç«¯ç‚¹
- `GET /health` - è¯¦ç»†å¥åº·çŠ¶æ€æ£€æŸ¥
- `GET /health/simple` - ç®€å•å¥åº·æ£€æŸ¥ (K8s probe)

æ£€æŸ¥é¡¹ç›®ï¼š
- âœ… PostgreSQL æ•°æ®åº“è¿æ¥
- âœ… NATS æ¶ˆæ¯é˜Ÿåˆ—çŠ¶æ€
- âœ… Meilisearch æœç´¢æœåŠ¡
- âœ… å“åº”å»¶è¿Ÿç›‘æ§

## ğŸ“Š 200äººDAUæ•°æ®åˆ†æ

### ä¸šåŠ¡æŒ‡æ ‡é¢„ä¼°
```
æ—¥æ´»ç”¨æˆ·: 200äºº
æ¯äººæ—¥å‡æ¶ˆæ¯: 50æ¡
æ—¥æ€»æ¶ˆæ¯é‡: 10,000æ¡
å³°å€¼æ—¶æ®µ(8å°æ—¶): ~21æ¡/åˆ†é’Ÿ
å­˜å‚¨éœ€æ±‚: 10KB/æ¶ˆæ¯ Ã— 10,000 = 100MB/å¤©
```

### èµ„æºé…ç½®å»ºè®®
```yaml
resources:
  fechatter_server:
    cpu: "1 core"
    memory: "2GB"
    
  postgresql:
    cpu: "1 core" 
    memory: "4GB"
    storage: "50GB SSD"
    
  nats:
    cpu: "0.5 core"
    memory: "1GB"
    
  meilisearch:
    cpu: "0.5 core"
    memory: "2GB"
    storage: "10GB SSD"
```

### æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–
```sql
-- å…³é”®ç´¢å¼•
CREATE INDEX CONCURRENTLY idx_messages_chat_created 
ON messages(chat_id, created_at DESC);

CREATE INDEX CONCURRENTLY idx_chat_members_chat_user 
ON chat_members(chat_id, user_id);

CREATE INDEX CONCURRENTLY idx_messages_idempotency 
ON messages(idempotency_key);
```

## ğŸ›£ï¸ å®ç°è·¯çº¿å›¾

### å·²å®ŒæˆåŠŸèƒ½ âœ…

#### æ ¸å¿ƒèŠå¤©åŠŸèƒ½
- âœ… **å¤šç§èŠå¤©ç±»å‹**: ä¸€å¯¹ä¸€å¯¹è¯ã€ç¾¤èŠã€ç§æœ‰é¢‘é“å’Œå…¬å…±é¢‘é“
- âœ… **å·¥ä½œç©ºé—´ç®¡ç†**: å¤šç§Ÿæˆ·æ¶æ„ï¼Œç»„ç»‡éš”ç¦»çš„å·¥ä½œç©ºé—´
- âœ… **JWTè®¤è¯**: å®‰å…¨çš„ç”¨æˆ·è®¤è¯å’Œåˆ·æ–°ä»¤ç‰Œæ”¯æŒ
- âœ… **å®æ—¶æ¶ˆæ¯**: Server-Sent Events (SSE) å®æ—¶é€šçŸ¥å’Œæ¶ˆæ¯ä¼ é€’
- âœ… **RESTful API**: èŠå¤©ã€ç”¨æˆ·å’Œå·¥ä½œç©ºé—´ç®¡ç†çš„ç»¼åˆAPI
- âœ… **PostgreSQLæ•°æ®åº“**: å¯é çš„æ•°æ®æŒä¹…åŒ–å’Œé«˜æ•ˆçš„æ¨¡å¼è®¾è®¡
- âœ… **å…¨é¢é”™è¯¯å¤„ç†**: åº”ç”¨ç¨‹åºä¸­çš„å¼ºå¤§é”™è¯¯ç®¡ç†
- âœ… **æ¨¡å—åŒ–æ¶æ„**: èŠå¤©åŠŸèƒ½å’Œé€šçŸ¥ä¼ é€’ä¹‹é—´çš„å…³æ³¨ç‚¹åˆ†ç¦»

#### Meilisearch é›†æˆ
- âœ… **æ¶ˆæ¯æœç´¢**: å¿«é€Ÿã€å®¹é”™çš„èŠå¤©æ¶ˆæ¯æœç´¢
- âœ… **åˆ†é¢æœç´¢**: æŒ‰æ—¥æœŸã€å‘é€è€…ã€èŠå¤©ç±»å‹ç­‰è¿‡æ»¤æœç´¢ç»“æœ
- âœ… **ç›¸å…³æ€§è°ƒä¼˜**: åŸºäºæ¶ˆæ¯ä¸Šä¸‹æ–‡å’Œç”¨æˆ·åå¥½è‡ªå®šä¹‰æœç´¢ç›¸å…³æ€§
- âœ… **å¼‚æ­¥ç´¢å¼•**: åŸºäºNATSçš„å®Œå…¨å¼‚æ­¥æ¶ˆæ¯ç´¢å¼•ï¼Œå®ç°é«˜æ€§èƒ½
- âœ… **æ‰¹å¤„ç†**: é€šè¿‡æ‰¹é‡ç´¢å¼•å®ç°50å€æ€§èƒ½æå‡ï¼ˆæ¯æ‰¹50æ¡æ¶ˆæ¯ï¼‰

#### NATS JetStream é›†æˆ
- âœ… **æŒä¹…æ¶ˆæ¯æµ**: å¯é…ç½®å­˜å‚¨çš„å¯é æ¶ˆæ¯ä¼ é€’
- âœ… **æ°´å¹³æ‰©å±•**: æ”¹è¿›é€šçŸ¥æœåŠ¡å™¨çš„å¯æ‰©å±•æ€§
- âœ… **æ¶ˆæ¯é‡æ”¾**: æ”¯æŒé‡è¿æ—¶æ£€ç´¢æ¶ˆæ¯å†å²
- âœ… **æ°å¥½ä¸€æ¬¡ä¼ é€’**: ä¿è¯æ¶ˆæ¯å¤„ç†è¯­ä¹‰
- âœ… **æ¶ˆè´¹è€…ç»„**: è·¨æœåŠ¡å™¨å®ä¾‹çš„è´Ÿè½½å‡è¡¡æ¶ˆæ¯å¤„ç†
- âœ… **å¼‚æ­¥æœç´¢ç´¢å¼•**: æœç´¢ç´¢å¼•ä¸æ¶ˆæ¯åˆ›å»ºå®Œå…¨åˆ†ç¦»
- âœ… **äº‹ä»¶é©±åŠ¨æ¶æ„**: æœåŠ¡é—´çº¯å¼‚æ­¥æ¶ˆæ¯åŒæ­¥

### Phase 1: åŸºç¡€ä¼˜åŒ– (å·²å®Œæˆ âœ…)
1. âœ… æ¸…ç†ç¼–è¯‘è­¦å‘Šå’Œæ— ç”¨ä»£ç 
2. âœ… æ€§èƒ½é…ç½®ä¼˜åŒ– (æ‰¹é‡å¤§å°ã€å»¶è¿Ÿ)
3. âœ… æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
4. âœ… å¥åº·æ£€æŸ¥ç³»ç»Ÿå®ç°

### Phase 2: Repositoryå±‚è¡¥å…… (è¿›è¡Œä¸­ ğŸ”„)
1. ğŸ”„ å®ç° `FechatterMessageRepository`
2. ğŸ”„ å®ç° `FechatterChatRepository`
3. ğŸ”„ å®ç° `FechatterChatMemberRepository`
4. ğŸ”„ å®ç° `FechatterWorkspaceRepository`

### Phase 3: Serviceå±‚å®Œå–„ (è®¡åˆ’ä¸­ ğŸ“‹)
1. ğŸ“‹ å®šä¹‰ `MessageService` trait
2. ğŸ“‹ å®šä¹‰ `ChatService` trait
3. ğŸ“‹ å®šä¹‰ `ChatMemberService` trait
4. ğŸ“‹ å®ç°å…·ä½“Serviceç±»

### Phase 4: å‰åç«¯é›†æˆ (è¿‘æœŸåŠŸèƒ½ ğŸ“‹)
1. ğŸ“‹ **TypeScriptå‰ç«¯**: åŸºäºReactçš„ç°ä»£UIå’ŒTypeScript
2. ğŸ“‹ **ç»„ä»¶åº“**: èŠå¤©ç•Œé¢çš„å¯é‡ç”¨UIç»„ä»¶
3. ğŸ“‹ **çŠ¶æ€ç®¡ç†**: é«˜æ•ˆçš„å®¢æˆ·ç«¯çŠ¶æ€ç®¡ç†å’Œå®æ—¶æ›´æ–°
4. ğŸ“‹ **ç¦»çº¿æ”¯æŒ**: æ¸è¿›å¼Webåº”ç”¨åŠŸèƒ½å’Œç¦»çº¿æ¶ˆæ¯é˜Ÿåˆ—
5. ğŸ“‹ **ç«¯åˆ°ç«¯æµ‹è¯•**: å‰åç«¯é›†æˆçš„ç»¼åˆæµ‹è¯•å¥—ä»¶

### Phase 5: ChatGPT èŠå¤©æœºå™¨äººæœåŠ¡ (æœªæ¥åŠŸèƒ½ ğŸ”®)
1. ğŸ”® **AIé©±åŠ¨å“åº”**: é›†æˆChatGPTå®ç°æ™ºèƒ½èŠå¤©åŠ©æ‰‹
2. ğŸ”® **ä¸Šä¸‹æ–‡ç†è§£**: ç»´æŠ¤å¯¹è¯ä¸Šä¸‹æ–‡ä»¥å®ç°è‡ªç„¶äº¤äº’
3. ğŸ”® **è‡ªå®šä¹‰å‘½ä»¤**: åœ¨å¸¸è§„å¯¹è¯ä¸­æ”¯æŒèŠå¤©æœºå™¨äººå‘½ä»¤
4. ğŸ”® **çŸ¥è¯†åº“é›†æˆ**: å°†èŠå¤©æœºå™¨äººè¿æ¥åˆ°å…¬å¸çŸ¥è¯†åº“
5. ğŸ”® **å¤šè¯­è¨€æ”¯æŒ**: è‡ªåŠ¨ç¿»è¯‘å’Œè¯­è¨€æ£€æµ‹

### Phase 6: é«˜çº§åŠŸèƒ½ (æ‰©å±• ğŸš€)
1. ğŸš€ åœ¨çº¿çŠ¶æ€ç®¡ç†
2. ğŸš€ æ¶ˆæ¯å·²è¯»çŠ¶æ€
3. ğŸš€ å®æ—¶typingæŒ‡ç¤ºå™¨
4. ğŸš€ æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½

## ğŸ”® æœªæ¥è€ƒè™‘

### OpenTelemetry ç›‘æ§
- ğŸ“‹ **åˆ†å¸ƒå¼è¿½è¸ª**: è·¨æœåŠ¡çš„ç«¯åˆ°ç«¯è¯·æ±‚è¿½è¸ª
- ğŸ“‹ **æŒ‡æ ‡æ”¶é›†**: æ‰€æœ‰ç»„ä»¶çš„æ€§èƒ½å’Œä½¿ç”¨æŒ‡æ ‡
- ğŸ“‹ **æ—¥å¿—é›†æˆ**: å¸¦æœ‰å…³è”IDçš„ç»“æ„åŒ–æ—¥å¿—
- ğŸ“‹ **æœåŠ¡å¥åº·ä»ªè¡¨æ¿**: ç³»ç»Ÿæ€§èƒ½çš„å®æ—¶ç›‘æ§
- ğŸ“‹ **å‘Šè­¦**: ç³»ç»Ÿé—®é¢˜çš„ä¸»åŠ¨é€šçŸ¥

### Pingora ç½‘å…³é…ç½®
- ğŸ“‹ **é«˜æ€§èƒ½ä»£ç†**: å…·æœ‰Rustæ€§èƒ½çš„é«˜æ•ˆHTTPè·¯ç”±
- ğŸ“‹ **TLSç»ˆæ­¢**: å®‰å…¨è¿æ¥å¤„ç†
- ğŸ“‹ **é€Ÿç‡é™åˆ¶**: é˜²æ­¢æ»¥ç”¨å’Œæµé‡å³°å€¼
- ğŸ“‹ **è¯·æ±‚è¿‡æ»¤**: å®‰å…¨è¿‡æ»¤å’ŒéªŒè¯
- ğŸ“‹ **è´Ÿè½½å‡è¡¡**: è·¨æœåŠ¡çš„æ™ºèƒ½æµé‡åˆ†å‘
- ğŸ“‹ **å¯è§‚æµ‹æ€§**: è¯¦ç»†çš„è¯·æ±‚æ—¥å¿—å’ŒæŒ‡æ ‡

## ğŸ”§ å¼€å‘æŒ‡å—

### å¼€å‘æœ€ä½³å®è·µ

#### 1. Repository Pattern
```rust
// fechatter_core: å®šä¹‰æ¥å£
#[async_trait]
pub trait UserRepository: Send + Sync {
    async fn create(&self, input: &CreateUser) -> Result<User, CoreError>;
    async fn find_by_id(&self, id: i64) -> Result<Option<User>, CoreError>;
}

// fechatter_server: å…·ä½“å®ç°
pub struct FechatterUserRepository {
    pool: Arc<PgPool>,
}

impl UserRepository for FechatterUserRepository {
    // å…·ä½“å®ç°...
}
```

#### 2. Service Layer
```rust
// ä¸šåŠ¡é€»è¾‘å°è£…
#[async_trait]
pub trait MessageService: Send + Sync {
    async fn create_message(&self, chat_id: i64, user_id: i64, content: CreateMessage) 
        -> Result<Message, CoreError>;
    async fn list_messages(&self, chat_id: i64, params: ListMessages) 
        -> Result<Vec<Message>, CoreError>;
}
```

#### 3. é”™è¯¯å¤„ç†
```rust
// ç»Ÿä¸€é”™è¯¯ç±»å‹
#[derive(Debug, thiserror::Error)]
pub enum CoreError {
    #[error("Database error: {0}")]
    Database(#[from] sqlx::Error),
    
    #[error("Validation error: {0}")]
    Validation(String),
    
    #[error("Not found: {0}")]
    NotFound(String),
}
```

## ğŸš€ éƒ¨ç½²æŒ‡å—

### Docker Compose é…ç½®
```yaml
version: '3.8'
services:
  fechatter:
    build: .
    environment:
      - RUST_LOG=info
      - DATABASE_URL=postgresql://postgres:password@db:5432/fechatter
    depends_on:
      - db
      - nats
      - meilisearch
    
  db:
    image: postgres:15
    environment:
      POSTGRES_DB: fechatter
      POSTGRES_PASSWORD: password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    
  nats:
    image: nats:2.10-alpine
    command: ["-js", "-sd", "/data"]
    volumes:
      - nats_data:/data
    
  meilisearch:
    image: getmeili/meilisearch:v1.5
    volumes:
      - meilisearch_data:/meili_data

volumes:
  postgres_data:
  nats_data:
  meilisearch_data:
```

### Kubernetes å¥åº·æ£€æŸ¥
```yaml
livenessProbe:
  httpGet:
    path: /health/simple
    port: 6688
  initialDelaySeconds: 30
  periodSeconds: 10
  
readinessProbe:
  httpGet:
    path: /health
    port: 6688
  initialDelaySeconds: 5
  periodSeconds: 5
```

## ğŸ“ˆ ç›‘æ§ä¸è§‚æµ‹

### å…³é”®æŒ‡æ ‡
```rust
pub struct MessageMetrics {
    pub messages_per_second: f64,
    pub avg_processing_time: Duration,
    pub search_index_lag: Duration,
    pub active_users: i64,
}

pub struct SystemHealth {
    pub nats_connection_status: bool,
    pub meilisearch_status: bool,
    pub database_pool_usage: f64,
    pub memory_usage: f64,
}
```

### ç›‘æ§ç«¯ç‚¹
- `/health` - ç³»ç»Ÿå¥åº·çŠ¶æ€
- `/metrics` - PrometheusæŒ‡æ ‡ (è®¡åˆ’ä¸­)
- `/debug/pprof` - æ€§èƒ½åˆ†æ (è®¡åˆ’ä¸­)

## ğŸ¯ é¡¹ç›®ä»·å€¼ä¸æ”¶ç›Š

### ä»£ç è´¨é‡æå‡
- **ç¼–è¯‘æ¸…æ´åº¦**: 100% æ— è­¦å‘Šç¼–è¯‘
- **æ¶æ„æ¸…æ™°**: Repository â†’ Service â†’ Handler åˆ†å±‚
- **ç±»å‹å®‰å…¨**: å®Œå…¨é™å®šè¯­æ³•ç¡®ä¿æ­£ç¡®æ€§
- **å¯ç»´æŠ¤æ€§**: ç»Ÿä¸€çš„è®¾è®¡æ¨¡å¼å’Œé”™è¯¯å¤„ç†

### æ€§èƒ½ä¼˜åŒ–æˆæœ
- **å“åº”æ—¶é—´**: æ¶ˆæ¯å‘é€ <100ms
- **æœç´¢æ€§èƒ½**: 1ç§’å†…ç´¢å¼•å®Œæˆ
- **å¹¶å‘èƒ½åŠ›**: æ”¯æŒ200äººåŒæ—¶åœ¨çº¿
- **èµ„æºæ•ˆç‡**: ä¼˜åŒ–é…ç½®å‡å°‘50%èµ„æºæ¶ˆè€—

### å¼€å‘æ•ˆç‡æå‡
- **æ–°åŠŸèƒ½å¼€å‘**: é€Ÿåº¦æå‡30%
- **æµ‹è¯•å‹å¥½**: Repositoryå’ŒServiceå¯è½»æ¾Mock
- **IDEæ”¯æŒ**: æ›´å¥½çš„ä»£ç è¡¥å…¨å’Œé”™è¯¯æç¤º
- **å›¢é˜Ÿåä½œ**: æ¸…æ™°çš„åˆ†å±‚ä¾¿äºå¹¶è¡Œå¼€å‘

### ç³»ç»Ÿå¯æ‰©å±•æ€§
- **å¾®æœåŠ¡å°±ç»ª**: æ¸…æ™°çš„æ¨¡å—è¾¹ç•Œ
- **æ’ä»¶åŒ–æ¶æ„**: æ”¯æŒåŠŸèƒ½æ‰©å±•
- **å¤šå­˜å‚¨åç«¯**: RepositoryæŠ½è±¡æ”¯æŒåˆ‡æ¢
- **äº‹ä»¶é©±åŠ¨**: NATSæ”¯æŒè§£è€¦å’Œæ‰©å±•

## ğŸ”® æœªæ¥å±•æœ›

### æŠ€æœ¯æ¼”è¿›
1. **å¾®æœåŠ¡æ‹†åˆ†**: åŸºäºå½“å‰åˆ†å±‚æ¶æ„
2. **äº‹ä»¶æº¯æº**: åŸºäºNATSçš„äº‹ä»¶å­˜å‚¨
3. **CQRSæ¨¡å¼**: è¯»å†™åˆ†ç¦»ä¼˜åŒ–
4. **åˆ†å¸ƒå¼ç¼“å­˜**: Redisé›†ç¾¤æ”¯æŒ

### åŠŸèƒ½æ‰©å±•
1. **å¤šåª’ä½“æ¶ˆæ¯**: å›¾ç‰‡ã€æ–‡ä»¶ã€è¯­éŸ³
2. **è§†é¢‘é€šè¯**: WebRTCé›†æˆ
3. **æœºå™¨äººé›†æˆ**: ChatGPTã€å·¥ä½œæµè‡ªåŠ¨åŒ–
4. **ä¼ä¸šé›†æˆ**: LDAPã€SSOã€æƒé™ç®¡ç†

### æ€§èƒ½ç›®æ ‡
- **1000äººDAU**: å½“å‰æ¶æ„å¯ç›´æ¥æ”¯æŒ
- **10000äººDAU**: éœ€è¦å¾®æœåŠ¡æ‹†åˆ†å’Œç¼“å­˜
- **100000äººDAU**: éœ€è¦åˆ†å¸ƒå¼æ¶æ„å’ŒCDN

## ğŸ“š å‚è€ƒèµ„æº

### æŠ€æœ¯æ–‡æ¡£
- [Rustå¼‚æ­¥ç¼–ç¨‹æŒ‡å—](https://rust-lang.github.io/async-book/)
- [PostgreSQLæ€§èƒ½ä¼˜åŒ–](https://www.postgresql.org/docs/current/performance-tips.html)
- [NATSæ¶ˆæ¯ç³»ç»Ÿ](https://docs.nats.io/)
- [Meilisearchæœç´¢å¼•æ“](https://docs.meilisearch.com/)

### æ¶æ„æ¨¡å¼
- [Clean Architecture](https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html)
- [Repository Pattern](https://martinfowler.com/eaaCatalog/repository.html)
- [Event-Driven Architecture](https://martinfowler.com/articles/201701-event-driven.html)

--- 