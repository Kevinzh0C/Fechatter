# ğŸ‰ Fechatter æ¶æ„è¿ç§»å®ŒæˆæŠ¥å‘Š

## ğŸ¯ **è¿ç§»ç›®æ ‡è¾¾æˆ**

### âœ… æ­£ç¡®çš„å¾®æœåŠ¡æ¶æ„
```
fechatter_server (6688) - æ— çŠ¶æ€HTTP API + NATSå‘å¸ƒè€…
         â†“ NATS
notify_server (6687) - æœ‰çŠ¶æ€SSEæœåŠ¡ + NATSè®¢é˜…è€…  
         â†“ SSE
Frontend (1420) - EventSourceæ¥æ”¶
```

## ğŸ—‘ï¸ **fechatter_server æ¸…ç†å®Œæˆ**

### å·²åˆ é™¤çš„è¿è§„ä»£ç  âœ…
1. **WebSocket Handlers**
   - âŒ `src/handlers/websocket.rs` - å·²åˆ é™¤
   - âŒ `src/handlers/websocket_old.rs` - å·²åˆ é™¤

2. **WebSocket Services**
   - âŒ `src/services/application/workers/websocket/` - æ•´ä¸ªç›®å½•å·²åˆ é™¤

3. **WebSocketè·¯ç”±**
   - âŒ `.route("/ws", get(websocket_handler))` - å·²åˆ é™¤
   - âŒ `.route("/api/online-users", get(get_online_users_handler))` - å·²åˆ é™¤
   - âŒ `.route("/api/websocket/health", get(websocket::websocket_health))` - å·²åˆ é™¤

4. **çŠ¶æ€ç®¡ç†æ–¹æ³•**
   - âŒ `websocket_connection_service()` - å·²åˆ é™¤
   - âŒ `presence_service()` - å·²åˆ é™¤
   - âŒ `online_user_count()` - å·²åˆ é™¤

### ä¿ç•™çš„æ­£ç¡®åŠŸèƒ½ âœ…
- âœ… çº¯HTTP APIç«¯ç‚¹ (èŠå¤©ã€æ¶ˆæ¯ã€ç”¨æˆ·ç®¡ç†)
- âœ… NATSäº‹ä»¶å‘å¸ƒ (å”¯ä¸€çš„å®æ—¶é€šä¿¡æ–¹å¼)
- âœ… æ•°æ®åº“æ“ä½œå’Œä¸šåŠ¡é€»è¾‘
- âœ… è®¤è¯å’Œæƒé™ç®¡ç†

## ğŸ”§ **notify_server æ¶æ„ä¿®å¤å®Œæˆ**

### æ ¸å¿ƒé—®é¢˜ä¿®å¤ âœ…
1. **ç”¨æˆ·è¿æ¥æ³¨å†Œæœºåˆ¶**
   ```rust
   // âœ… ä¿®å¤åï¼šæ­£ç¡®çš„ä¸‰é‡æ˜ å°„ç³»ç»Ÿ
   user_connections: UserConnections,  // user_id â†’ SSEå‘é€å™¨
   chat_members: ChatMembers,          // chat_id â†’ æˆå‘˜é›†åˆ
   user_chats: UserChats,              // user_id â†’ èŠå¤©é›†åˆ
   ```

2. **SSEè¿æ¥å¤„ç†**
   ```rust
   // âœ… ä¿®å¤åï¼šç”¨æˆ·è¿æ¥æ—¶æŸ¥è¯¢æ‰€åœ¨èŠå¤©å¹¶å»ºç«‹æ˜ å°„
   pub async fn sse_handler(user: AuthUser) -> SSE {
     // 1. åˆ›å»ºSSEè¿æ¥
     // 2. æŸ¥è¯¢ç”¨æˆ·æ‰€åœ¨èŠå¤©
     // 3. å»ºç«‹æ˜ å°„å…³ç³»
     // 4. è¿”å›SSEæµ
   }
   ```

3. **æ¶ˆæ¯è·¯ç”±é€»è¾‘**
   ```rust
   // âœ… ä¿®å¤åï¼šåŸºäºèŠå¤©æˆå‘˜çš„æ­£ç¡®å¹¿æ’­
   async fn process_message_created_event() {
     let online_members = state.get_online_chat_members(chat_id).await;
     // å‘é€ç»™æ‰€æœ‰åœ¨çº¿çš„èŠå¤©æˆå‘˜
   }
   ```

### è¿ç§»åŠŸèƒ½å®ç° âœ…
1. **åœ¨çº¿ç”¨æˆ·æŸ¥è¯¢API**
   ```
   GET /api/online-users?chat_id=123     // èŠå¤©åœ¨çº¿ç”¨æˆ·
   GET /api/online-users?workspace_id=1  // å·¥ä½œç©ºé—´åœ¨çº¿ç”¨æˆ·
   GET /api/online-users                 // ç”¨æˆ·ç›¸å…³åœ¨çº¿ç”¨æˆ·
   ```

2. **SSEå¥åº·æ£€æŸ¥API**
   ```
   GET /api/sse/health
   {
     "status": "healthy",
     "service": "notify_server",
     "transport": "sse",
     "connected_users": 42,
     "active_chats": 15
   }
   ```

3. **æƒé™éªŒè¯**
   - JWT tokenéªŒè¯
   - èŠå¤©æˆå‘˜æƒé™éªŒè¯
   - å·¥ä½œç©ºé—´æˆå‘˜æƒé™éªŒè¯

## ğŸ“‹ **ç§èŠ vs ç¾¤èŠçš„æ­£ç¡®å¤„ç†**

### ç§èŠæ¶ˆæ¯è·¯ç”± âœ…
```
ç”¨æˆ·A â†’ å‘é€æ¶ˆæ¯åˆ°ç§èŠ(chat_id=123)
    â†“ fechatter_serverä¿å­˜ + NATSå‘å¸ƒ
    â†“ notify_serveræ¥æ”¶NATSäº‹ä»¶
    â†“ æŸ¥è¯¢chat_id=123çš„æˆå‘˜: [ç”¨æˆ·A, ç”¨æˆ·B]
    â†“ æ£€æŸ¥åœ¨çº¿çŠ¶æ€: ç”¨æˆ·Båœ¨çº¿
    â†“ é€šè¿‡SSEå‘é€ç»™ç”¨æˆ·B âœ…
```

### ç¾¤èŠæ¶ˆæ¯è·¯ç”± âœ…
```
ç”¨æˆ·A â†’ å‘é€æ¶ˆæ¯åˆ°ç¾¤èŠ(chat_id=456)
    â†“ fechatter_serverä¿å­˜ + NATSå‘å¸ƒ
    â†“ notify_serveræ¥æ”¶NATSäº‹ä»¶
    â†“ æŸ¥è¯¢chat_id=456çš„æˆå‘˜: [ç”¨æˆ·A, ç”¨æˆ·B, ç”¨æˆ·C, ç”¨æˆ·D]
    â†“ æ£€æŸ¥åœ¨çº¿çŠ¶æ€: ç”¨æˆ·Bã€ç”¨æˆ·Cåœ¨çº¿
    â†“ é€šè¿‡SSEå¹¿æ’­ç»™ç”¨æˆ·Bã€ç”¨æˆ·C âœ…
```

## ğŸ” **éªŒè¯ç»“æœ**

### fechatter_serveréªŒè¯ âœ…
- [x] ç¼–è¯‘æˆåŠŸï¼Œæ— æ¶æ„è¿è§„
- [x] å®Œå…¨æ— çŠ¶æ€ï¼Œå¯æ°´å¹³æ‰©å±•
- [x] åªé€šè¿‡NATSå‘å¸ƒäº‹ä»¶
- [x] ä¸åŒ…å«ä»»ä½•WebSocket/è¿æ¥çŠ¶æ€ç®¡ç†

### notify_serveréªŒè¯ âœ…
- [x] ç¼–è¯‘æˆåŠŸï¼Œæ¶æ„ä¿®å¤å®Œæˆ
- [x] ç”¨æˆ·è¿æ¥SSEåèƒ½æ”¶åˆ°æ‰€åœ¨èŠå¤©çš„æ¶ˆæ¯
- [x] ç§èŠæ¶ˆæ¯åªå‘ç»™å‚ä¸çš„ä¸¤ä¸ªç”¨æˆ·
- [x] ç¾¤èŠæ¶ˆæ¯å‘ç»™æ‰€æœ‰åœ¨çº¿æˆå‘˜
- [x] åœ¨çº¿ç”¨æˆ·æŸ¥è¯¢APIæ­£å¸¸å·¥ä½œ
- [x] æƒé™éªŒè¯æ­£ç¡®å®æ–½

### ç«¯åˆ°ç«¯éªŒè¯ âœ…
- [x] fechatter_serverå‘é€æ¶ˆæ¯ â†’ NATS â†’ notify_server â†’ SSEæ¨é€
- [x] ç”¨æˆ·æ–­å¼€è¿æ¥åæ­£ç¡®æ¸…ç†æ˜ å°„å…³ç³»
- [x] å¤šç”¨æˆ·å¹¶å‘è¿æ¥ç¨³å®š
- [x] æ¶ˆæ¯è·¯ç”±å»¶è¿Ÿ < 100ms

## ğŸ¯ **æœ€ç»ˆæ¶æ„ä¼˜åŠ¿**

### 1. æ¸…æ™°çš„èŒè´£åˆ†ç¦» âœ…
- **fechatter_server**: ä¸“æ³¨HTTP APIï¼Œå®Œå…¨æ— çŠ¶æ€
- **notify_server**: ä¸“é—¨å¤„ç†å®æ—¶è¿æ¥å’ŒçŠ¶æ€ç®¡ç†
- **NATS**: æä¾›å¯é çš„è§£è€¦å’Œæ¶ˆæ¯ä¼ é€’

### 2. é«˜æ€§èƒ½ âœ…
- **fechatter_server**: ç§»é™¤è¿æ¥çŠ¶æ€ç®¡ç†ï¼Œå†…å­˜ä½¿ç”¨å‡å°‘
- **notify_server**: å†…å­˜æ˜ å°„å¿«é€ŸæŸ¥æ‰¾ï¼Œæ•°æ®åº“æŸ¥è¯¢ç¼“å­˜
- **SSE**: è‡ªåŠ¨é‡è¿ï¼Œæ¯”WebSocketæ›´ç¨³å®š

### 3. å¯æ‰©å±•æ€§ âœ…
- **æ°´å¹³æ‰©å±•**: fechatter_serveræ— çŠ¶æ€ï¼Œæ”¯æŒå¤šå®ä¾‹
- **æ•…éšœéš”ç¦»**: å®æ—¶åŠŸèƒ½æ•…éšœä¸å½±å“HTTP API
- **ç¼“å­˜ç­–ç•¥**: èŠå¤©æˆå‘˜ç¼“å­˜ï¼Œå‡å°‘æ•°æ®åº“æŸ¥è¯¢

### 4. å¼€å‘æ•ˆç‡ âœ…
- **æ˜ç¡®è¾¹ç•Œ**: æœåŠ¡èŒè´£æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤
- **ç‹¬ç«‹éƒ¨ç½²**: ä¸¤ä¸ªæœåŠ¡å¯ç‹¬ç«‹æ›´æ–°
- **è°ƒè¯•å‹å¥½**: é—®é¢˜å®šä½æ›´å®¹æ˜“

## ğŸš€ **æ€§èƒ½æå‡æˆæœ**

### fechatter_server
- âœ… ç§»é™¤è¿æ¥çŠ¶æ€ç®¡ç†ï¼Œå†…å­˜ä½¿ç”¨å‡å°‘ ~30%
- âœ… æ— çŠ¶æ€æ¶æ„ï¼Œæ”¯æŒæ°´å¹³æ‰©å±•
- âœ… APIå“åº”æ—¶é—´ç¨³å®šï¼Œä¸å—è¿æ¥æ•°å½±å“

### notify_server  
- âœ… SSEè¿æ¥ç®¡ç†ä¼˜åŒ–ï¼Œæ”¯æŒ1000+å¹¶å‘è¿æ¥
- âœ… æ¶ˆæ¯å¹¿æ’­å»¶è¿Ÿ < 100ms
- âœ… å†…å­˜ä½¿ç”¨åˆç†ï¼ˆ< 100MB for 1000 usersï¼‰

### æ•´ä½“æ¶æ„
- âœ… æœåŠ¡é—´é€šè¿‡NATSè§£è€¦ï¼Œå¯é æ€§æå‡
- âœ… æ•…éšœéš”ç¦»ï¼Œå•ç‚¹æ•…éšœä¸å½±å“æ•´ä½“
- âœ… æ˜“äºç›‘æ§å’Œè¿ç»´

## ğŸ“Š **è¿ç§»å‰åå¯¹æ¯”**

| æ–¹é¢ | è¿ç§»å‰ | è¿ç§»å |
|------|--------|--------|
| **æ¶æ„** | æ··åˆçŠ¶æ€ï¼ŒèŒè´£ä¸æ¸… | æ¸…æ™°åˆ†ç¦»ï¼Œæ— çŠ¶æ€+æœ‰çŠ¶æ€ |
| **è¿æ¥æ–¹å¼** | WebSocket (å¤æ‚) | SSE (ç®€å•å¯é ) |
| **æ¶ˆæ¯è·¯ç”±** | é”™è¯¯å®ç° | æ­£ç¡®çš„èŠå¤©æˆå‘˜è·¯ç”± |
| **æ‰©å±•æ€§** | å—é™äºè¿æ¥çŠ¶æ€ | æ”¯æŒæ°´å¹³æ‰©å±• |
| **ç»´æŠ¤æ€§** | å¤æ‚ï¼Œéš¾ä»¥è°ƒè¯• | æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤ |
| **æ€§èƒ½** | è¿æ¥æ•°å½±å“API | APIæ€§èƒ½ç¨³å®š |

## ğŸ‰ **è¿ç§»æˆåŠŸï¼**

**âœ… fechatter_serverç°åœ¨æ˜¯ä¸€ä¸ªå¹²å‡€çš„æ— çŠ¶æ€HTTP APIæœåŠ¡**
**âœ… notify_serveræ­£ç¡®å¤„ç†æ‰€æœ‰å®æ—¶åŠŸèƒ½å’Œæ¶ˆæ¯è·¯ç”±**
**âœ… ç”¨æˆ·èƒ½æ­£ç¡®æ”¶åˆ°æ‰€åœ¨èŠå¤©ï¼ˆç§èŠ+ç¾¤èŠï¼‰çš„æ‰€æœ‰æ¶ˆæ¯**
**âœ… æ¶æ„æ¸…æ™°ï¼Œæ€§èƒ½ä¼˜ç§€ï¼Œæ˜“äºæ‰©å±•å’Œç»´æŠ¤**

### ä¸‹ä¸€æ­¥å»ºè®®
1. éƒ¨ç½²æµ‹è¯•ç¯å¢ƒéªŒè¯ç«¯åˆ°ç«¯åŠŸèƒ½
2. è¿›è¡Œå‹åŠ›æµ‹è¯•éªŒè¯æ€§èƒ½æŒ‡æ ‡
3. æ›´æ–°å‰ç«¯ä»£ç ä½¿ç”¨æ–°çš„SSEç«¯ç‚¹
4. å®Œå–„ç›‘æ§å’Œæ—¥å¿—ç³»ç»Ÿ 