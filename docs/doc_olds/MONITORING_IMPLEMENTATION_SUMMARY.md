# Fechatter ç›‘æ§å®æ–½æ€»ç»“

## âœ… å®ŒæˆçŠ¶æ€

æ‰€æœ‰å››ä¸ªæœåŠ¡å™¨ç°åœ¨éƒ½å·²é…ç½®å®Œæ•´çš„ Prometheus ç›‘æ§ï¼

### ğŸ“Š Prometheus Metrics ç«¯ç‚¹

| æœåŠ¡å™¨ | ä¸»ç«¯å£ | Metrics ç«¯å£ | å¥åº·æ£€æŸ¥ | çŠ¶æ€ |
|--------|--------|--------------|----------|------|
| fechatter_server | 6688 | 9090 | âœ… /health, /ready, /live | âœ… å®Œå…¨å®æ–½ |
| notify_server | 6689 | 9091 | âœ… /health, /ready, /live | âœ… å®Œå…¨å®æ–½ |
| bot_server | - | 9092 | âœ… :6686/health, /ready, /live | âœ… å®Œå…¨å®æ–½ |
| analytics_server | 7777 | 7778 | âœ… /health, /ready, /live | âœ… å®Œå…¨å®æ–½ |

### ğŸ¯ ç›‘æ§è¦†ç›–ç‡

#### fechatter_server (ä¸»æœåŠ¡å™¨)
- **HTTP è¯·æ±‚**: è¯·æ±‚æ•°ã€å“åº”æ—¶é—´ã€é”™è¯¯ç‡ï¼ˆæŒ‰è·¯ç”±ã€æ–¹æ³•ã€çŠ¶æ€ç ï¼‰
- **æ•°æ®åº“æ“ä½œ**: æŸ¥è¯¢æ—¶é—´ã€é”™è¯¯ç‡ã€è¿æ¥æ± çŠ¶æ€
- **ç¼“å­˜æ“ä½œ**: å‘½ä¸­ç‡ã€æ“ä½œå»¶è¿Ÿã€ç¼“å­˜å¤§å°
- **æ¶ˆæ¯ç³»ç»Ÿ**: å‘é€/æ¥æ”¶æ•°é‡ã€å¤„ç†æ—¶é—´
- **WebSocket**: æ´»è·ƒè¿æ¥æ•°ã€æ¶ˆæ¯ååé‡
- **æ–‡ä»¶ä¸Šä¼ **: æˆåŠŸç‡ã€å¤§å°åˆ†å¸ƒã€å¤„ç†æ—¶é—´
- **ä¸šåŠ¡æŒ‡æ ‡**: æ´»è·ƒç”¨æˆ·ã€èŠå¤©åˆ›å»ºã€æ¶ˆæ¯å‘é€é‡

#### notify_server (é€šçŸ¥æœåŠ¡å™¨)
- **SSE è¿æ¥**: æ´»è·ƒè¿æ¥æ•°ã€è¿æ¥æ—¶é•¿ã€æ–­å¼€ç‡
- **NATS æ¶ˆæ¯**: æ¥æ”¶/å¤„ç†æ•°é‡ã€å¤„ç†æ—¶é—´ã€é”™è¯¯ç‡
- **äº‹ä»¶å¹¿æ’­**: å¹¿æ’­æˆåŠŸç‡ã€å¤±è´¥åŸå› åˆ†æ
- **åœ¨çº¿ç”¨æˆ·**: å®æ—¶ç”¨æˆ·æ•°ã€æŸ¥è¯¢æ€§èƒ½
- **å¥åº·æ£€æŸ¥**: æ£€æŸ¥é¢‘ç‡ã€å“åº”æ—¶é—´

#### bot_server (æœºå™¨äººæœåŠ¡å™¨)
- **NATS äº‹ä»¶**: äº‹ä»¶æ¥æ”¶/å¤„ç†æ•°é‡ã€å¤„ç†å»¶è¿Ÿ
- **æ¶ˆæ¯ç´¢å¼•**: ç´¢å¼•æˆåŠŸç‡ã€å¤„ç†æ—¶é—´
- **å‘é‡åµŒå…¥**: ç”ŸæˆæˆåŠŸç‡ã€ç»´åº¦åˆ†å¸ƒã€API å»¶è¿Ÿ
- **æœç´¢ç´¢å¼•**: æ–‡æ¡£ç´¢å¼•æ•°é‡ã€ç´¢å¼•æ—¶é—´
- **AI ä»£ç†**: è¯·æ±‚æˆåŠŸç‡ã€å“åº”æ—¶é—´ã€ä»¤ç‰Œä½¿ç”¨é‡
- **æ•°æ®åº“**: æ“ä½œå»¶è¿Ÿã€è¿æ¥æ± çŠ¶æ€

#### analytics_server (åˆ†ææœåŠ¡å™¨)
- **HTTP API**: äº‹ä»¶æ‘„å–é€Ÿç‡ã€æ‰¹å¤„ç†å¤§å°
- **ClickHouse**: æ’å…¥/æŸ¥è¯¢æ€§èƒ½ã€è¿æ¥çŠ¶æ€ã€é”™è¯¯ç‡
- **NATS è®¢é˜…**: æ¶ˆæ¯å¤„ç†é€Ÿç‡ã€è®¢é˜…çŠ¶æ€
- **äº‹ä»¶å¤„ç†**: äº‹ä»¶ç±»å‹åˆ†å¸ƒã€å¤„ç†å»¶è¿Ÿã€éªŒè¯é”™è¯¯
- **ä¼šè¯ç®¡ç†**: æ´»è·ƒä¼šè¯æ•°ã€ä¼šè¯æ—¶é•¿
- **æŸ¥è¯¢æ€§èƒ½**: æŸ¥è¯¢ç±»å‹ã€å“åº”æ—¶é—´ã€ç»“æœå¤§å°

### ğŸ› ï¸ å®æ–½ç»†èŠ‚

#### 1. é€šç”¨ç›‘æ§æ¨¡å¼
æ¯ä¸ªæœåŠ¡å™¨éƒ½å®ç°äº†ç›¸åŒçš„ç›‘æ§æ¨¡å¼ï¼š
- `observability/mod.rs` - ç›‘æ§åˆå§‹åŒ–å…¥å£
- `observability/metrics.rs` - Prometheus æŒ‡æ ‡å®šä¹‰å’Œæ”¶é›†å™¨
- æ ‡å‡†åŒ–çš„æŒ‡æ ‡å‘½åè§„èŒƒï¼š`{service}_${domain}_${metric}_${unit}`

#### 2. æŒ‡æ ‡æ”¶é›†å™¨
ä¸ºæ¯ä¸ªåŠŸèƒ½åŸŸåˆ›å»ºäº†ä¸“é—¨çš„æ”¶é›†å™¨ï¼š
```rust
// ç¤ºä¾‹ï¼šSSE è¿æ¥ç›‘æ§
SSEMetrics::connection_opened();
SSEMetrics::connection_closed(duration);
SSEMetrics::record_active_connections(count);
```

#### 3. å¥åº·æ£€æŸ¥æ ‡å‡†åŒ–
æ‰€æœ‰æœåŠ¡å®ç°äº†ä¸‰ä¸ªå¥åº·æ£€æŸ¥ç«¯ç‚¹ï¼š
- `/health` - ç»¼åˆå¥åº·çŠ¶æ€ï¼ˆåŒ…å«ä¾èµ–æ£€æŸ¥ï¼‰
- `/ready` - å°±ç»ªçŠ¶æ€ï¼ˆæœåŠ¡æ˜¯å¦å‡†å¤‡å¥½æ¥æ”¶æµé‡ï¼‰
- `/live` - å­˜æ´»çŠ¶æ€ï¼ˆæœåŠ¡æ˜¯å¦å“åº”ï¼‰

### ğŸ“ˆ Grafana ä»ªè¡¨æ¿å»ºè®®

#### 1. ç³»ç»Ÿæ¦‚è§ˆä»ªè¡¨æ¿
- æ‰€æœ‰æœåŠ¡çš„å¥åº·çŠ¶æ€
- æ€»è¯·æ±‚é‡å’Œé”™è¯¯ç‡
- ç³»ç»Ÿèµ„æºä½¿ç”¨ç‡
- å…³é”®ä¸šåŠ¡æŒ‡æ ‡æ±‡æ€»

#### 2. æœåŠ¡ä¸“å±ä»ªè¡¨æ¿
- **Fechatter ä¸»æœåŠ¡**: ç”¨æˆ·æ´»åŠ¨ã€æ¶ˆæ¯æµé‡ã€API æ€§èƒ½
- **é€šçŸ¥æœåŠ¡**: SSE è¿æ¥çŠ¶æ€ã€äº‹ä»¶åˆ†å‘æ€§èƒ½
- **æœºå™¨äººæœåŠ¡**: AI å¤„ç†æ€§èƒ½ã€ç´¢å¼•çŠ¶æ€
- **åˆ†ææœåŠ¡**: äº‹ä»¶æ‘„å–ç‡ã€æŸ¥è¯¢æ€§èƒ½

#### 3. ä¸šåŠ¡æŒ‡æ ‡ä»ªè¡¨æ¿
- æ—¥æ´»è·ƒç”¨æˆ·ï¼ˆDAUï¼‰
- æ¶ˆæ¯å‘é€è¶‹åŠ¿
- èŠå¤©åˆ›å»ºå’Œå‚ä¸åº¦
- æ–‡ä»¶ä¸Šä¼ ç»Ÿè®¡
- æœç´¢ä½¿ç”¨æƒ…å†µ

### ğŸš¨ å»ºè®®çš„æŠ¥è­¦è§„åˆ™

```yaml
groups:
  - name: fechatter_critical
    rules:
      - alert: ServiceDown
        expr: up{job=~"fechatter.*"} == 0
        for: 1m
        labels:
          severity: critical
          
      - alert: HighErrorRate
        expr: rate(fechatter_http_errors_total[5m]) > 0.1
        for: 2m
        labels:
          severity: warning
          
      - alert: DatabaseConnectionPoolExhausted
        expr: fechatter_db_connections_active > 90
        for: 1m
        labels:
          severity: critical
          
      - alert: NATSSubscriptionDown
        expr: notify_nats_subscription_active == 0
        for: 30s
        labels:
          severity: critical
          
      - alert: HighMemoryUsage
        expr: process_resident_memory_bytes > 1e9
        for: 5m
        labels:
          severity: warning
```

### ğŸš€ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **ç«‹å³ï¼ˆå·²å®Œæˆï¼‰**:
   - âœ… æ‰€æœ‰æœåŠ¡å™¨çš„ Prometheus metrics å®æ–½
   - âœ… æ ‡å‡†åŒ–å¥åº·æ£€æŸ¥ç«¯ç‚¹
   - âœ… å…³é”®ä¸šåŠ¡æµç¨‹çš„æŒ‡æ ‡è¦†ç›–

2. **æœ¬å‘¨å†…**:
   - [ ] é…ç½® Prometheus æœåŠ¡å™¨æ”¶é›†æ‰€æœ‰æŒ‡æ ‡
   - [ ] åˆ›å»º Grafana ä»ªè¡¨æ¿
   - [ ] è®¾ç½®åŸºç¡€æŠ¥è­¦è§„åˆ™

3. **ä¸‹å‘¨**:
   - [ ] ä¼˜åŒ–æŒ‡æ ‡æ”¶é›†æ€§èƒ½
   - [ ] æ·»åŠ è‡ªå®šä¹‰ä¸šåŠ¡æŒ‡æ ‡
   - [ ] åˆ›å»ºè¿ç»´æ‰‹å†Œ

### ğŸ“ è¿ç»´æç¤º

1. **æŒ‡æ ‡æ”¶é›†**:
   ```bash
   # Prometheus é…ç½®ç¤ºä¾‹
   scrape_configs:
     - job_name: 'fechatter_server'
       static_configs:
         - targets: ['localhost:9090']
     - job_name: 'notify_server'
       static_configs:
         - targets: ['localhost:9091']
     - job_name: 'bot_server'
       static_configs:
         - targets: ['localhost:9092']
     - job_name: 'analytics_server'
       static_configs:
         - targets: ['localhost:7778']
   ```

2. **å¥åº·æ£€æŸ¥ç›‘æ§**:
   ```bash
   # æ£€æŸ¥æ‰€æœ‰æœåŠ¡å¥åº·çŠ¶æ€
   curl http://localhost:6688/health
   curl http://localhost:6689/health
   curl http://localhost:6686/health
   curl http://localhost:7777/health
   ```

3. **æŒ‡æ ‡æŸ¥è¯¢ç¤ºä¾‹**:
   ```promql
   # æŸ¥çœ‹æ‰€æœ‰æœåŠ¡çš„è¯·æ±‚ç‡
   sum(rate(http_requests_total[5m])) by (service)
   
   # æŸ¥çœ‹é”™è¯¯ç‡
   sum(rate(http_errors_total[5m])) by (service, status)
   
   # æŸ¥çœ‹ p95 å“åº”æ—¶é—´
   histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))
   ```

---

**å®Œæˆæ—¶é—´**: 2025-01-09
**å®æ–½è€…**: Fechatter å›¢é˜Ÿ
**çŠ¶æ€**: âœ… å®Œå…¨å®æ–½