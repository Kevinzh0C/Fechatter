# ğŸ” Fechatter Gateway - Authentication Architecture Update\n\n## ğŸ“‹ **æ¶æ„å˜æ›´æ€»ç»“**\n\næˆ‘ä»¬å·²å°† **JWT è®¤è¯è´£ä»»ä» Gateway è½¬ç§»åˆ°åç«¯æœåŠ¡**ï¼Œå®ç°äº†æ›´æ¸…æ™°çš„æœåŠ¡åˆ†ç¦»å’Œæ›´å¥½çš„å®‰å…¨éš”ç¦»ã€‚\n\n---\n\n## ğŸ”„ **æ¶æ„å¯¹æ¯”**\n\n### **æ—§æ¶æ„ (âŒ)**\n```\nå‰ç«¯åº”ç”¨ â”€â”€JWTâ”€â”€â–¶ Gateway (éªŒè¯JWT) â”€â”€è¯·æ±‚+ç”¨æˆ·ä¸Šä¸‹æ–‡â”€â”€â–¶ åç«¯æœåŠ¡\n           â†‘         â”‚                              â†‘\n           â”‚         â”œâ”€ JWT Secret ç®¡ç†              â”‚\n           â”‚         â”œâ”€ ç”¨æˆ·ä¸Šä¸‹æ–‡æå–                â”‚\n           â”‚         â””â”€ æƒé™éªŒè¯é€»è¾‘                  â”‚\n           â””â”€â”€401/403â”€â”˜                               â”‚\n                                                     â”‚\n                        å¤æ‚çš„ä¸­é—´ä»¶é“¾ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n### **æ–°æ¶æ„ (âœ…)**\n```\nå‰ç«¯åº”ç”¨ â”€â”€JWTâ”€â”€â–¶ Gateway (çº¯ä»£ç†) â”€â”€JWT (é€ä¼ )â”€â”€â–¶ åç«¯æœåŠ¡ (éªŒè¯JWT)\n           â†‘                                        â”‚\n           â”‚                                        â”œâ”€ JWT Secret ç®¡ç†\n           â”‚                                        â”œâ”€ ç”¨æˆ·ä¸Šä¸‹æ–‡æå–\n           â”‚                                        â”œâ”€ æƒé™éªŒè¯é€»è¾‘\n           â”‚                                        â””â”€ ä¸šåŠ¡é€»è¾‘å¤„ç†\n           â””â”€â”€â”€â”€â”€â”€â”€â”€401/403 (é€ä¼ )â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n---\n\n## ğŸ¯ **å˜æ›´åŠ¨æœº**\n\n### **1. å®‰å…¨éš”ç¦»**\n- âœ… **JWT Secret éš”ç¦»**: Gateway ä¸å†éœ€è¦è®¿é—® JWT å¯†é’¥\n- âœ… **æ”»å‡»é¢å‡å°**: Gateway è¢«æ”»ç ´ä¸ä¼šæ³„éœ²è®¤è¯æœºåˆ¶\n- âœ… **æƒé™é›†ä¸­ç®¡ç†**: è®¤è¯é€»è¾‘é›†ä¸­åœ¨ä¸“é—¨çš„æœåŠ¡ä¸­\n\n### **2. æœåŠ¡èŒè´£åˆ†ç¦»**\n- âœ… **Gateway**: çº¯ç²¹çš„åå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡\n- âœ… **Backend**: å®Œæ•´çš„è®¤è¯ã€æˆæƒå’Œä¸šåŠ¡é€»è¾‘\n- âœ… **ç»´æŠ¤ç®€åŒ–**: è®¤è¯é€»è¾‘å˜æ›´ä¸å½±å“ Gateway\n\n### **3. å¯æ‰©å±•æ€§**\n- âœ… **æœåŠ¡ç‹¬ç«‹**: å„æœåŠ¡å¯ä»¥ç‹¬ç«‹æ‰©å±•å’Œéƒ¨ç½²\n- âœ… **æŠ€æœ¯æ ˆè‡ªç”±**: åç«¯æœåŠ¡å¯ä»¥é€‰æ‹©ä¸åŒçš„è®¤è¯æ–¹æ¡ˆ\n- âœ… **ç‰ˆæœ¬æ§åˆ¶**: è®¤è¯é€»è¾‘å’Œ Gateway å¯ä»¥ç‹¬ç«‹ç‰ˆæœ¬ç®¡ç†\n\n---\n\n## ğŸ”§ **å®ç°ç»†èŠ‚**\n\n### **Gateway é…ç½®å˜æ›´**\n\n#### **ç§»é™¤çš„ä¸­é—´ä»¶**\n```yaml\n# âŒ å·²ç§»é™¤\nmiddleware: [ \"auth\", \"ratelimit\", \"cors\" ]\n\n# âœ… æ–°é…ç½®\nmiddleware: [ \"ratelimit\", \"cors\" ]  # ç§»é™¤ \"auth\"\n```\n\n#### **ç®€åŒ–çš„è·¯ç”±**\n```yaml\n# æ‰€æœ‰ API è·¯ç”±éƒ½ç§»é™¤äº†è®¤è¯ä¸­é—´ä»¶\n- path: \"/api/\"\n  methods: [ \"GET\", \"POST\", \"PUT\", \"DELETE\", \"PATCH\", \"OPTIONS\" ]\n  upstream: fechatter-api\n  middleware: [ \"ratelimit\", \"cors\" ]  # ä¸åŒ…å« \"auth\"\n```\n\n#### **ç¼“å­˜ç­–ç•¥æ›´æ–°**\n```yaml\n# âŒ æ—§ç¼“å­˜é…ç½® - åŸºäºè®¤è¯ç”¨æˆ·\ncache:\n  rules:\n  - paths: [ \"/api/v1/chats/*/messages\" ]\n    vary_headers: [ \"authorization\" ]  # åŸºäºç”¨æˆ·çš„ç¼“å­˜\n\n# âœ… æ–°ç¼“å­˜é…ç½® - å…¬å…±ç«¯ç‚¹ç¼“å­˜\ncache:\n  rules:\n  - paths: [ \"/health\", \"/api/health\", \"/metrics\" ]\n    key_params: []  # ç®€åŒ–çš„ç¼“å­˜é”®\n```\n\n### **åç«¯æœåŠ¡èŒè´£**\n\n#### **fechatter-server ç°åœ¨è´Ÿè´£**\n1. **JWT Token éªŒè¯**\n   ```rust\n   // åœ¨æ¯ä¸ªéœ€è¦è®¤è¯çš„å¤„ç†å™¨ä¸­\n   let user = extract_user_from_jwt(&auth_header)?;\n   ```\n\n2. **ç”¨æˆ·æƒé™æ£€æŸ¥**\n   ```rust\n   // ä¸šåŠ¡é€»è¾‘ä¸­çš„æƒé™éªŒè¯\n   if !user.can_access_chat(chat_id) {\n       return Err(AppError::Forbidden);\n   }\n   ```\n\n3. **è®¤è¯é”™è¯¯å¤„ç†**\n   ```rust\n   // è¿”å›æ ‡å‡†çš„ HTTP çŠ¶æ€ç \n   Err(AppError::Unauthorized) // 401\n   Err(AppError::Forbidden)    // 403\n   ```\n\n---\n\n## ğŸš€ **éƒ¨ç½²é…ç½®**\n\n### **å¼€å‘ç¯å¢ƒ (`config/development.yml`)**\n```yaml\n# âœ… ç®€æ´çš„è·¯ç”±é…ç½®\nroutes:\n- path: \"/api/\"\n  methods: [ \"GET\", \"POST\", \"PUT\", \"PATCH\", \"DELETE\", \"OPTIONS\" ]\n  upstream: \"fechatter-server\"  # è®¤è¯ç”±æ­¤æœåŠ¡å¤„ç†\n  cors_enabled: true\n  cors_origins:\n  - \"http://localhost:1420\"\n```\n\n### **ç”Ÿäº§ç¯å¢ƒ (`config/production.yml`)**\n```yaml\n# âœ… ç”Ÿäº§çº§é…ç½®\nroutes:\n- path: \"/api/\"\n  methods: [ \"GET\", \"POST\", \"PUT\", \"PATCH\", \"DELETE\", \"OPTIONS\" ]\n  upstream: \"fechatter-server\"\n  cors_enabled: true\n  cors_origins:\n  - \"https://fechatter.v0.app\"\n  - \"https://*.v0.app\"\n```\n\n---\n\n## ğŸ“Š **æ€§èƒ½å½±å“**\n\n### **ä¼˜åŠ¿**\n- âœ… **Gateway å»¶è¿Ÿé™ä½**: ç§»é™¤è®¤è¯ä¸­é—´ä»¶å‡å°‘å¤„ç†æ—¶é—´\n- âœ… **å†…å­˜ä½¿ç”¨å‡å°‘**: Gateway ä¸éœ€è¦ç¼“å­˜ç”¨æˆ·ä¼šè¯\n- âœ… **CPU ä½¿ç”¨ä¼˜åŒ–**: å‡å°‘ JWT è§£æå’ŒéªŒè¯è®¡ç®—\n\n### **æƒè¡¡**\n- âš ï¸ **åç«¯è´Ÿè½½å¢åŠ **: è®¤è¯é€»è¾‘è½¬ç§»åˆ°åç«¯æœåŠ¡\n- âš ï¸ **ç½‘ç»œè¯·æ±‚**: æ¯ä¸ªè¯·æ±‚éƒ½éœ€è¦åç«¯éªŒè¯ï¼ˆä½†è¿™æ˜¯å¿…è¦çš„ï¼‰\n\n### **ä¼˜åŒ–æªæ–½**\n- âœ… **Token ç¼“å­˜**: åç«¯æœåŠ¡å¯ä»¥ç¼“å­˜å·²éªŒè¯çš„ token\n- âœ… **è¿æ¥æ± **: æ•°æ®åº“è¿æ¥å¤ç”¨å‡å°‘è®¤è¯æŸ¥è¯¢å¼€é”€\n- âœ… **JWT è¿‡æœŸç®¡ç†**: åˆç†è®¾ç½® token è¿‡æœŸæ—¶é—´\n\n---\n\n## ğŸ§ª **æµ‹è¯•éªŒè¯**\n\n### **è®¤è¯æµç¨‹æµ‹è¯•**\n```bash\n# 1. æµ‹è¯•æœªè®¤è¯è¯·æ±‚\ncurl -X GET http://localhost:8080/api/chats\n# æœŸæœ›: 401 Unauthorized (ç”± fechatter-server è¿”å›)\n\n# 2. æµ‹è¯•æœ‰æ•ˆ token\ncurl -X GET http://localhost:8080/api/chats \\\n  -H \"Authorization: Bearer <valid-jwt-token>\"\n# æœŸæœ›: 200 OK (æˆåŠŸå“åº”)\n\n# 3. æµ‹è¯•æ— æ•ˆ token\ncurl -X GET http://localhost:8080/api/chats \\\n  -H \"Authorization: Bearer invalid-token\"\n# æœŸæœ›: 401 Unauthorized (ç”± fechatter-server è¿”å›)\n```\n\n### **Gateway å¥åº·æ£€æŸ¥**\n```bash\n# Gateway æœ¬èº«çš„å¥åº·çŠ¶æ€ï¼ˆä¸éœ€è¦è®¤è¯ï¼‰\ncurl http://localhost:8080/health\n# æœŸæœ›: 200 OK\n\n# åç«¯æœåŠ¡å¥åº·çŠ¶æ€ï¼ˆé€šè¿‡ Gateway ä»£ç†ï¼‰\ncurl http://localhost:8080/api/health\n# æœŸæœ›: 200 OK\n```\n\n---\n\n## ğŸ”® **æœªæ¥ä¼˜åŒ–æ–¹å‘**\n\n### **çŸ­æœŸä¼˜åŒ–**\n1. **Token ç¼“å­˜**: åœ¨ Redis ä¸­ç¼“å­˜å·²éªŒè¯çš„ token\n2. **æ‰¹é‡éªŒè¯**: æ”¯æŒæ‰¹é‡ token éªŒè¯å‡å°‘æ•°æ®åº“æŸ¥è¯¢\n3. **æ€§èƒ½ç›‘æ§**: æ·»åŠ è®¤è¯æ€§èƒ½æŒ‡æ ‡ç›‘æ§\n\n### **é•¿æœŸè§„åˆ’**\n1. **OAuth2/OIDC**: æ”¯æŒæ ‡å‡†çš„ OAuth2 è®¤è¯æµç¨‹\n2. **å¤šå› å­è®¤è¯**: æ·»åŠ  2FA æ”¯æŒ\n3. **SSO é›†æˆ**: æ”¯æŒä¼ä¸šçº§å•ç‚¹ç™»å½•\n\n---\n\n## ğŸ“š **ç›¸å…³æ–‡æ¡£**\n\n- [Gateway é…ç½®æŒ‡å—](./README.md)\n- [åç«¯è®¤è¯å®ç°](../fechatter_server/docs/authentication.md)\n- [API æ–‡æ¡£](../docs/api.md)\n- [éƒ¨ç½²æŒ‡å—](../docs/deployment.md)\n\n---\n\n## ğŸ¤ **è¿ç§»æ£€æŸ¥æ¸…å•**\n\n- [x] **Gateway é…ç½®æ›´æ–°**\n  - [x] ç§»é™¤ JWT ä¸­é—´ä»¶é…ç½®\n  - [x] æ›´æ–°è·¯ç”±è§„åˆ™\n  - [x] ç®€åŒ–ç¼“å­˜ç­–ç•¥\n  \n- [x] **åç«¯æœåŠ¡æ›´æ–°**\n  - [x] å®ç° JWT éªŒè¯é€»è¾‘\n  - [x] æ·»åŠ è®¤è¯é”™è¯¯å¤„ç†\n  - [x] æ›´æ–°æƒé™æ£€æŸ¥\n  \n- [x] **é…ç½®æ–‡ä»¶åŒæ­¥**\n  - [x] å¼€å‘ç¯å¢ƒé…ç½®\n  - [x] ç”Ÿäº§ç¯å¢ƒé…ç½®\n  - [x] å‚è€ƒé…ç½®æ›´æ–°\n  \n- [x] **æµ‹è¯•éªŒè¯**\n  - [x] è®¤è¯æµç¨‹æµ‹è¯•\n  - [x] é”™è¯¯å¤„ç†æµ‹è¯•\n  - [x] æ€§èƒ½åŸºå‡†æµ‹è¯•\n\n---\n\n## âœ… **å˜æ›´å®ŒæˆçŠ¶æ€**\n\n**å½“å‰æ¶æ„**: Gateway ä½œä¸ºçº¯åå‘ä»£ç†ï¼Œæ‰€æœ‰è®¤è¯é€»è¾‘ç”±åç«¯æœåŠ¡å¤„ç†\n\n**çŠ¶æ€**: âœ… **å·²å®Œæˆå¹¶éªŒè¯** - æ–°æ¶æ„å·²ç»å®æ–½å¹¶é€šè¿‡æµ‹è¯•\n\n**ä¸‹ä¸€æ­¥**: æŒç»­ç›‘æ§æ€§èƒ½æŒ‡æ ‡ï¼Œæ ¹æ®éœ€è¦è¿›è¡Œä¼˜åŒ–è°ƒæ•´ 